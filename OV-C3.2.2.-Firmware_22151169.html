<!DOCTYPE html>
<html>
    <head>
        <title>ONALABS QMS : OV C3.2.2. Firmware</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">ONALABS QMS</a></span>
                            </li>
                                                    <li>
                                <span><a href="OV-ONAVITAL-MDR-Product-Technical-File_3342337.html">OV ONAVITAL MDR Product Technical File</a></span>
                            </li>
                                                    <li>
                                <span><a href="3342576.html">OV Part C: Design and Manufacturing Information</a></span>
                            </li>
                                                    <li>
                                <span><a href="OV-C3.2.-Detailed-Design_3342611.html">OV C3.2. Detailed Design</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            ONALABS QMS : OV C3.2.2. Firmware
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                            
        
    
        
    
        
        
            Created by <span class='author'> Jaime Punter</span>, last modified on May 20, 2025
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><span class="status-macro aui-lozenge aui-lozenge-visual-refresh aui-lozenge-error">COMPANY CONFIDENTIAL</span> <span class="status-macro aui-lozenge aui-lozenge-visual-refresh aui-lozenge-error">UNCONTROLLED IF PRINTED</span></p><p>Owner: Albert Alvarez</p><div class="ap-container" id="ap-com.automation-consultants.accloud.approvalmacro__ApprovalsStatusMacro1827058707332028739">

  <div class="ap-content " id="embedded-com.automation-consultants.accloud.approvalmacro__ApprovalsStatusMacro1827058707332028739"></div>
  <script nonce="528a568c4bd9f0fff5a3a25050ba0fb5" class="ap-iframe-body-script">
  (function(){
    var data = {
    "addon_key":"com.automation-consultants.accloud.approvalmacro",
    "uniqueKey":"com.automation-consultants.accloud.approvalmacro__ApprovalsStatusMacro1827058707332028739",
    "key":"ApprovalsStatusMacro",
     "moduleType":"dynamicContentMacros",      "moduleLocation":"content",         "cp":"/wiki",
            "general":"",
    "w":"",
    "h":"",
    "url":"https://ac-cloud.com/approvalmacro/macro/page-status/display?xdm_e=https%3A%2F%2Fonalabs.atlassian.net&xdm_c=channel-com.automation-consultants.accloud.approvalmacro__ApprovalsStatusMacro1827058707332028739&cp=%2Fwiki&xdm_deprecated_addon_key_do_not_use=com.automation-consultants.accloud.approvalmacro&lic=active&cv=1000.0.0-c58bc7260813&traceId=38b9cdd6fa101428d47cd5d835d3b78c&spanId=5c99809fa43eb0bd&traceSampled=0&jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiI2MDU0OTY2Yjk0ZDdiOTAwNjkwMmRkMWUiLCJxc2giOiIyNGJlY2Q5Mjk5ODJhM2Q0MDc0MjgwYzAyMzE4MWVlY2EwOWE0ZTFkOTRkYWM2OTgxZTgyNTMyOGYxZTQzNGYwIiwiaXNzIjoiNzdjODA3YTAtMmNjNy0zZWVjLWEzNDItOWQzYzYyZjUwZWE0IiwiY29udGV4dCI6e30sImV4cCI6MTc1MTI5NTE3OCwiaWF0IjoxNzUxMjk0OTk4fQ.6_qnDrDMmxlFepL8rZosrhOqlgatuLXzpiADBRoBoPI",
     "contextJwt": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiI2MDU0OTY2Yjk0ZDdiOTAwNjkwMmRkMWUiLCJxc2giOiJjb250ZXh0LXFzaCIsImlzcyI6Ijc3YzgwN2EwLTJjYzctM2VlYy1hMzQyLTlkM2M2MmY1MGVhNCIsImNvbnRleHQiOnsibGljZW5zZSI6eyJhY3RpdmUiOnRydWV9LCJjb25mbHVlbmNlIjp7ImVkaXRvciI6eyJ2ZXJzaW9uIjoidjIifSwibWFjcm8iOnsib3V0cHV0VHlwZSI6Imh0bWxfZXhwb3J0IiwiaGFzaCI6IjcxZDQzNjUxLWUwOWMtNGVjZC04NzlmLTBjODhmNTA0ZmUzNSIsImlkIjoiNzFkNDM2NTEtZTA5Yy00ZWNkLTg3OWYtMGM4OGY1MDRmZTM1In0sInRyYWNpbmciOnsidHJhY2VJZCI6IjM4YjljZGQ2ZmExMDE0MjhkNDdjZDVkODM1ZDNiNzhjIiwic3BhbklkIjoiNWM5OTgwOWZhNDNlYjBiZCIsInNhbXBsZWQiOiIwIn0sImNvbnRlbnQiOnsidHlwZSI6InBhZ2UiLCJ2ZXJzaW9uIjoiMTUiLCJpZCI6IjIyMTUxMTY5In0sInNwYWNlIjp7ImtleSI6Ik9OQUxBQlNRTVMiLCJpZCI6IjI3NTI1MTIifX0sInVybCI6eyJkaXNwbGF5VXJsIjoiaHR0cHM6XC9cL29uYWxhYnMuYXRsYXNzaWFuLm5ldFwvd2lraSJ9fSwiZXhwIjoxNzUxMjk1ODk4LCJpYXQiOjE3NTEyOTQ5OTh9.kBK8LeuFJW1k-BtEoBDPZK6krwo0GbNrUU3SkyHFdMk",    "structuredContext": "{\"license\":{\"active\":true},\"confluence\":{\"editor\":{\"version\":\"v2\"},\"macro\":{\"outputType\":\"html_export\",\"hash\":\"71d43651-e09c-4ecd-879f-0c88f504fe35\",\"id\":\"71d43651-e09c-4ecd-879f-0c88f504fe35\"},\"tracing\":{\"traceId\":\"38b9cdd6fa101428d47cd5d835d3b78c\",\"spanId\":\"5c99809fa43eb0bd\",\"sampled\":\"0\"},\"content\":{\"type\":\"page\",\"version\":\"15\",\"id\":\"22151169\"},\"space\":{\"key\":\"ONALABSQMS\",\"id\":\"2752512\"}},\"url\":{\"displayUrl\":\"https://onalabs.atlassian.net/wiki\"}}",
    "contentClassifier":"content",
    "productCtx":"{\"page.id\":\"22151169\",\"macro.hash\":\"71d43651-e09c-4ecd-879f-0c88f504fe35\",\"space.key\":\"ONALABSQMS\",\"tracing.sampled\":\"0\",\"page.type\":\"page\",\"content.version\":\"15\",\"page.title\":\"OV C3.2.2. Firmware\",\"macro.localId\":\"cb53a6bf-5b60-4b60-9d49-ecd4af7c9630\",\"macro.body\":\"\",\": = | RAW | = :\":null,\"space.id\":\"2752512\",\"macro.truncated\":\"false\",\"content.type\":\"page\",\"output.type\":\"html_export\",\"page.version\":\"15\",\"macro.fragmentLocalId\":\"\",\"content.id\":\"22151169\",\"tracing.traceId\":\"38b9cdd6fa101428d47cd5d835d3b78c\",\"macro.id\":\"71d43651-e09c-4ecd-879f-0c88f504fe35\",\"tracing.spanId\":\"5c99809fa43eb0bd\",\"user.isExternalCollaborator\":\"false\",\"editor.version\":\"v2\"}",
    "timeZone":"GB",
    "origin":"https://ac-cloud.com",
    "hostOrigin":"https://onalabs.atlassian.net",
    "sandbox":"allow-downloads allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-scripts allow-same-origin allow-top-navigation-by-user-activation allow-storage-access-by-user-activation",    "pearApp":"true",        "apiMigrations": {
        "gdpr": true
    }
}
;
    if(window.AP && window.AP.subCreate) {
      window._AP.appendConnectAddon(data);
    } else {
      require(['ac/create'], function(create){
        create.appendConnectAddon(data);
      });
    }

    // For Confluence App Analytics. This code works in conjunction with CFE's ConnectSupport.js.
    // Here, we add a listener to the initial HTML page that stores events if the ConnectSupport component
    // has not mounted yet. In CFE, we process the missed event data and disable this initial listener.
    const __MAX_EVENT_ARRAY_SIZE__ = 20;
    const connectAppAnalytics = "ecosystem.confluence.connect.analytics";
    window.connectHost && window.connectHost.onIframeEstablished((eventData) => {
      if (!window.__CONFLUENCE_CONNECT_SUPPORT_LOADED__) {
        let events = JSON.parse(window.localStorage.getItem(connectAppAnalytics)) || [];
        if (events.length >= __MAX_EVENT_ARRAY_SIZE__) {
          events.shift();
        }
        events.push(eventData);
        window.localStorage.setItem(connectAppAnalytics, JSON.stringify(events));
      }
    });

  }());
</script>

</div>
<p /><style type='text/css'>/*<![CDATA[*/
div.rbtoc1751294998459 {padding: 0px;}
div.rbtoc1751294998459 ul {list-style: default;margin-left: 0px;}
div.rbtoc1751294998459 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1751294998459'>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>1</span> <a href='#OVC3.2.2.Firmware-Glossary'>Glossary</a></li>
<li><span class='TOCOutline'>2</span> <a href='#OVC3.2.2.Firmware-Purpose'>Purpose</a></li>
<li><span class='TOCOutline'>3</span> <a href='#OVC3.2.2.Firmware-Introduction'>Introduction</a></li>
<li><span class='TOCOutline'>4</span> <a href='#OVC3.2.2.Firmware-Architecturestackoverview'>Architecture stack overview</a></li>
<li><span class='TOCOutline'>5</span> <a href='#OVC3.2.2.Firmware-Sequentialdiagrams'>Sequential diagrams</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>5.1</span> <a href='#OVC3.2.2.Firmware-Normalinitializationsequence'>Normal initialization sequence</a></li>
</ul>
</li>
<li><span class='TOCOutline'>6</span> <a href='#OVC3.2.2.Firmware-Hierarchicalstatemachines'>Hierarchical state machines</a></li>
<li><span class='TOCOutline'>7</span> <a href='#OVC3.2.2.Firmware-Projectstructure'>Project structure</a></li>
<li><span class='TOCOutline'>8</span> <a href='#OVC3.2.2.Firmware-Pinout'>Pinout</a></li>
<li><span class='TOCOutline'>9</span> <a href='#OVC3.2.2.Firmware-STM32Cubeprojectconfiguration'>STM32Cube project configuration</a></li>
<li><span class='TOCOutline'>10</span> <a href='#OVC3.2.2.Firmware-Bluetooth®GenericAttributeProfile(GATT)'>Bluetooth® Generic Attribute Profile (GATT)</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>10.1</span> <a href='#OVC3.2.2.Firmware-Advertising'>Advertising</a></li>
<li><span class='TOCOutline'>10.2</span> <a href='#OVC3.2.2.Firmware-Profile'>Profile</a></li>
</ul>
</li>
<li><span class='TOCOutline'>11</span> <a href='#OVC3.2.2.Firmware-LEDindicator'>LED indicator</a></li>
<li><span class='TOCOutline'>12</span> <a href='#OVC3.2.2.Firmware-PPGconfiguration'>PPG configuration</a></li>
<li><span class='TOCOutline'>13</span> <a href='#OVC3.2.2.Firmware-Externalflashmemorymap'>External flash memory map</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>13.1</span> <a href='#OVC3.2.2.Firmware-Non-volatileFIFO'>Non-volatile FIFO</a></li>
<li><span class='TOCOutline'>13.2</span> <a href='#OVC3.2.2.Firmware-Brainstorming'>Brainstorming</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>13.2.1</span> <a href='#OVC3.2.2.Firmware-Analysisoffirstoption+additionalproposals'>Analysis of first option + additional proposals</a></li>
</ul>
</li>
</ul>
</li>
<li><span class='TOCOutline'>14</span> <a href='#OVC3.2.2.Firmware-BLEsecurity'>BLE security</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>14.1</span> <a href='#OVC3.2.2.Firmware-Pairingandbonding'>Pairing and bonding</a></li>
<li><span class='TOCOutline'>14.2</span> <a href='#OVC3.2.2.Firmware-Pairingprocess'>Pairing process</a></li>
<li><span class='TOCOutline'>14.3</span> <a href='#OVC3.2.2.Firmware-Over-the-airupdate'>Over-the-air update</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>14.3.1</span> <a href='#OVC3.2.2.Firmware-Encriptaciónyfirmaselasactualizaciones'>Encriptación y firma se las actualizaciones</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>14.3.1.1</span> <a href='#OVC3.2.2.Firmware-Autenticidad'>Autenticidad</a></li>
<li><span class='TOCOutline'>14.3.1.2</span> <a href='#OVC3.2.2.Firmware-Confidencialidad'>Confidencialidad</a></li>
<li><span class='TOCOutline'>14.3.1.3</span> <a href='#OVC3.2.2.Firmware-Integridad'>Integridad</a></li>
</ul>
</li>
<li><span class='TOCOutline'>14.3.2</span> <a href='#OVC3.2.2.Firmware-Securebootandsecurefirmwareupdate'>Secure boot and secure firmware update</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>14.3.2.1</span> <a href='#OVC3.2.2.Firmware-Esquemadeencriptación'>Esquema de encriptación</a></li>
<li><span class='TOCOutline'>14.3.2.2</span> <a href='#OVC3.2.2.Firmware-Númeroderanuras'>Número de ranuras</a></li>
<li><span class='TOCOutline'>14.3.2.3</span> <a href='#OVC3.2.2.Firmware-Cargadordefirmware'>Cargador de firmware</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>14.3.2.3.1</span> <a href='#OVC3.2.2.Firmware-Envíodelarchivodeactualización'>Envío del archivo de actualización</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>14.3.2.3.1.1</span> <a href='#OVC3.2.2.Firmware-Advertisingdataycaracterísticasdelaaplicacióndeusuario'>Advertising data y características de la aplicación de usuario</a></li>
<li><span class='TOCOutline'>14.3.2.3.1.2</span> <a href='#OVC3.2.2.Firmware-AdvertisingdataycaracterísticasdelaaplicaciónBLE_ota'>Advertising data y características de la aplicación BLE_ota</a></li>
<li><span class='TOCOutline'>14.3.2.3.1.3</span> <a href='#OVC3.2.2.Firmware-OTAupdateprocess'>OTA update process</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><span class='TOCOutline'>15</span> <a href='#OVC3.2.2.Firmware-OTPmemorybank'>OTP memory bank</a></li>
<li><span class='TOCOutline'>16</span> <a href='#OVC3.2.2.Firmware-BLEcommunication'>BLE communication</a></li>
<li><span class='TOCOutline'>17</span> <a href='#OVC3.2.2.Firmware-Pushbutton'>Push button</a></li>
<li><span class='TOCOutline'>18</span> <a href='#OVC3.2.2.Firmware-Batterymanagement'>Battery management</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>18.1</span> <a href='#OVC3.2.2.Firmware-Preventbatteryoverdischarge'>Prevent battery overdischarge</a></li>
</ul>
</li>
<li><span class='TOCOutline'>19</span> <a href='#OVC3.2.2.Firmware-Developmentsetup'>Development setup</a></li>
<li><span class='TOCOutline'>20</span> <a href='#OVC3.2.2.Firmware-Flashingproductionfirmware'>Flashing production firmware</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>20.1</span> <a href='#OVC3.2.2.Firmware-AESkeyprovisioning'>AES key provisioning</a></li>
<li><span class='TOCOutline'>20.2</span> <a href='#OVC3.2.2.Firmware-Optionbytesconfiguration'>Option bytes configuration</a></li>
</ul>
</li>
<li><span class='TOCOutline'>21</span> <a href='#OVC3.2.2.Firmware-Externaldocuments'>External documents</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>21.1</span> <a href='#OVC3.2.2.Firmware-DocumentDistribution'>Document Distribution</a></li>
</ul>
</li>
<li><span class='TOCOutline'>22</span> <a href='#OVC3.2.2.Firmware-Annex'>Annex</a></li>
<li><span class='TOCOutline'>23</span> <a href='#OVC3.2.2.Firmware-DocumentDistribution.1'>Document Distribution</a></li>
</ul>
</div><h1 id="OVC3.2.2.Firmware-Glossary">Glossary</h1><ul><li><p>AD – Advertising data</p></li><li><p>AES – Advanced encryption standard</p></li><li><p>BLE – Bluetooth® Low Energy</p></li><li><p>BSP – Board Support Package</p></li><li><p>CKS – Cryptographic key storage</p></li><li><p>ECB – Electronic codebook</p></li><li><p>ECDSA – Elliptic curve digital signature algorithm</p></li><li><p>CBC – Cipher block chaining</p></li><li><p>CCM – Counter with cipher block chaining message authentication code</p></li><li><p>CTR – Counter</p></li><li><p>GCM – Galois/counter</p></li><li><p>GMAC – Galois message authentication code</p></li><li><p>HAL – Hardware Abstraction Layer</p></li><li><p>IC – Integrated Circuit</p></li><li><p>IDE – Integrated Development Environment</p></li><li><p>IMU – Inertial Measurement Unit</p></li><li><p>LUT – LookUp Table</p></li><li><p>MITM – Man in the middle</p></li><li><p>OTA – Over-the-air</p></li><li><p>OTP – One-time-programmable</p></li><li><p>PPG – Photoplethysmogram</p></li><li><p>RTOS – Realtime Operating System</p></li><li><p>SBSFU – Secure boot and secure firmware update</p></li><li><p>SHA – Secure hash algorithm</p></li><li><p>SWV – Serial Wire Viewer</p></li><li><p>SQI – Signal Quality Indicator</p></li><li><p>WCS – Worst Case Scenario </p></li></ul><h1 id="OVC3.2.2.Firmware-Purpose">Purpose</h1><p>To detail software technical files.</p><h1 id="OVC3.2.2.Firmware-Introduction">Introduction</h1><p>This document contains a description of the Onavital architecture, directory structure, system specifications, table of services and features of the Bluetooth® LE module, and configuration of the STM32CubeIDE project.</p><h1 id="OVC3.2.2.Firmware-Architecturestackoverview">Architecture stack overview</h1><p>The architecture is composed of three layers: low-level, middleware, and application layers. The architecture makes use of dependency inversion to decouple the code between layers and facilitate future code modifications due to hardware modifications. The low-level layer is composed of the HAL and LL libraries provided by the microcontroller manufacturer (STMicroelectronics), and a BSP implemented by ONALABS to implement specific low-level functions (control of GPIOs, communication buses, or timers) that may require higher-level modules.</p><p>On the other hand, the middleware layer consists of libraries, frameworks and drivers used by the application layer. A first sub-module of this layer are the component drivers. These components are the battery management, the external flash memory, the IMU, the PPG, the temperature sensor, the Bluetooth® LE module. Whenever available, drivers provided by the different manufacturers are used. If not, custom drivers have been developed.</p><p>Another sub-module is the utilities sub-module. All utilities contained in this sub-module are provided by STMicroelectronics, which provides both the utilities and the interfaces that developers making use of these utilities must implement for their specific platform. The LPM utility provides a management of the different low-power modes of the microcontroller in such a way that it enables the mode that provides the lowest power consumption by the microcontroller considering the peripherals used. The timer server utility allows multiple tasks to be scheduled overtime using a single timer, in this case the low-power timer. The sequencer allows to schedule/execute tasks sequentially. It acts as a kind of simplified RTOS where tasks are not multiplexed in time and are executed until completion.</p><p>The library submodule contains the active-object and database engines and a calendar library. The active-object engine allows to implement an active-object based architecture in such a way that each module/function/context is decoupled from the rest. The different active objects communicate with each other via asynchronous messages. The database engine manages the storage and retrieval of data in the external flash memory by structuring its data. The calendar library allows transforming an epoch to the values needed by the microcontroller's RTC and vice versa.</p><p>The application layer contains the definition of each of the active objects of which it is composed. It contains both the implementation of each of the hierarchical state machines of each active object, as well as the different system events that may occur. More information about the implemented active-object can be found in section6Hierarchical state machines.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240223-095854.png" width="760" loading="lazy" src="attachments/22151169/235733007.png?width=760" data-image-src="attachments/22151169/235733007.png" data-height="671" data-width="824" data-unresolved-comment-count="0" data-linked-resource-id="235733007" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240223-095854.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="f521752f-81da-4425-9c9f-5d7a68f19f94" data-media-type="file"></span><h1 id="OVC3.2.2.Firmware-Sequentialdiagrams">Sequential diagrams</h1><h2 id="OVC3.2.2.Firmware-Normalinitializationsequence">Normal initialization sequence</h2><p>Normal conditions are understood as the correct detection of proximity during user presence detection obtaining positive SQIs (raw signals in compliance with the quality requirements requested by the algorithm (outside the scope of this document)).</p><p>The sequence assumes that the device was in stand-by mode (the user is not wearing the device and no measurement is being performed). The sequence starts with the user charging the device. When this happens, the device indicates to the user the start of the charging process by a steady blue LED. Once charged, the device indicates to the user the completion of the charging process by a steady green LED.</p><p>When the user disconnects the power supply from the device, the LED turns off. From then on, each time the device detects its manipulation (movement detection), it starts the process of detecting the user's presence (proximity detector) and indicates to the user the execution of the process by flashing the blue LED with a period of 1 second. The process ends either when the user's presence is detected or when the maximum time allowed for user presence detection has elapsed. If the second case occurs, the device returns to stand-by mode until it detects its manipulation again and starts the presence detection process.</p><p>If the user's presence has been detected, a first measurement of all parameters (temperature, steps, heart rate, oxygen saturation and blood pressure) is performed. Once the first measurements have been completed, the next measurements are programmed with a fixed pre-programmed period. Each time the period of the relevant parameter is completed, a measurement is taken and the next one is programmed at the end. This process is repeated if the presence of the user is detected from the PPG results. If the presence of the user is not detected, the device repeats the user presence detection process.</p><p>Each time a measurement is performed, the result is updated in the relevant feature of the BLE module.</p><p>When the device has already detected the user's presence and performs measurements periodically, it periodically (every 10 seconds) reads the BLE module characteristic for client-to-server requests when a PPG measurement is not being performed. If the client requests an on-demand measurement, the temporary scheduling of all measurements is suspended, and the measurement process of all parameters is started as it is done right after the user presence detection process.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="Imagen 1.png" width="788" loading="lazy" src="attachments/22151169/236290061.png?width=788" data-image-src="attachments/22151169/236290061.png" data-height="680" data-width="356" data-unresolved-comment-count="0" data-linked-resource-id="236290061" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Imagen 1.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="ffa762fc-1893-4faf-acab-1d9cb652345d" data-media-type="file"></span><h1 id="OVC3.2.2.Firmware-Hierarchicalstatemachines">Hierarchical state machines</h1><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240223-115812.png" width="760" loading="lazy" src="attachments/22151169/236159024.png?width=760" data-image-src="attachments/22151169/236159024.png" data-height="363" data-width="777" data-unresolved-comment-count="0" data-linked-resource-id="236159024" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240223-115812.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="1f3b0639-7b90-4161-8089-553526ea98c4" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240223-115836.png" width="760" loading="lazy" src="attachments/22151169/236060696.png?width=760" data-image-src="attachments/22151169/236060696.png" data-height="655" data-width="1204" data-unresolved-comment-count="0" data-linked-resource-id="236060696" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240223-115836.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="279b1d01-8d15-4ab0-82a1-62ac5b2d7256" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240223-115858.png" width="760" loading="lazy" src="attachments/22151169/235798539.png?width=760" data-image-src="attachments/22151169/235798539.png" data-height="166" data-width="927" data-unresolved-comment-count="0" data-linked-resource-id="235798539" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240223-115858.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="7abb551a-719a-4c5f-a884-8b397845bf10" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240223-115930.png" width="760" loading="lazy" src="attachments/22151169/235733022.png?width=760" data-image-src="attachments/22151169/235733022.png" data-height="664" data-width="1207" data-unresolved-comment-count="0" data-linked-resource-id="235733022" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240223-115930.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="fb12258e-2fb1-4493-bdd2-df9a061fa624" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240223-120001.png" width="760" loading="lazy" src="attachments/22151169/235831329.png?width=760" data-image-src="attachments/22151169/235831329.png" data-height="784" data-width="1176" data-unresolved-comment-count="0" data-linked-resource-id="235831329" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240223-120001.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="23106b8f-b1d7-43d1-aeae-80777e6a6bb1" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240223-120030.png" width="760" loading="lazy" src="attachments/22151169/235700243.png?width=760" data-image-src="attachments/22151169/235700243.png" data-height="774" data-width="1147" data-unresolved-comment-count="0" data-linked-resource-id="235700243" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240223-120030.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="6b6bb48d-3095-4665-b1f4-ef70a2c895c4" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240223-120057.png" width="414" loading="lazy" src="attachments/22151169/236027910.png?width=414" data-image-src="attachments/22151169/236027910.png" data-height="788" data-width="414" data-unresolved-comment-count="0" data-linked-resource-id="236027910" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240223-120057.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="0b6b12b2-6c4a-43eb-9528-555b02eafd51" data-media-type="file"></span><p /><h1 id="OVC3.2.2.Firmware-Projectstructure">Project structure</h1><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="fd122f48-8114-4661-8c6f-cd9dc75f53fe" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p><strong>Directory</strong></p></th><th class="confluenceTh"><p><strong>Contents</strong></p></th></tr><tr><th class="confluenceTh"><p>Core/Src/</p></th><td class="confluenceTd"><p>Application entry (main.c), user application folder (app/), legacy BSP files, and STM32CubeIDE generated peripheral HAL initialization files.</p></td></tr><tr><th class="confluenceTh"><p>Core/Src/app/</p></th><td class="confluenceTd"><p>User application. Contains the user application entry file (app.c), and the active objects folder (active-objects/).</p></td></tr><tr><th class="confluenceTh"><p>Core/Src/app/active-objects/</p></th><td class="confluenceTd"><p>Active objects folders, and user application events (de)allocator (ao_system_events.c).</p></td></tr><tr><th class="confluenceTh"><p>Core/Src/app/active-objects/ao-battery/</p></th><td class="confluenceTd"><p>Battery active object. Responsible for device power management. Also includes the LUT used for voltage-based battery charge level estimation (voltage_top_charge_conv.c).</p></td></tr><tr><th class="confluenceTh"><p>Core/Src/app/active-objects/ao-ble/</p></th><td class="confluenceTd"><p>Bluetooth® active object. Responsible for BLE module management (initial configuration, data exchange with the client, and low-power mode management).</p></td></tr><tr><th class="confluenceTh"><p>Core/Src/app/active-objects/ao-imu/</p></th><td class="confluenceTd"><p>IMU active object. Responsible for movement detection during stand-by mode, fall detection, and activity (steps) quantification.</p></td></tr><tr><th class="confluenceTh"><p>Core/Src/app/active-objects/ao-led/</p></th><td class="confluenceTd"><p>LED active object. Responsible for light indication.</p></td></tr><tr><th class="confluenceTh"><p>Core/Src/app/active-objects/ao-measurement/</p></th><td class="confluenceTd"><p>Measurement active object. Responsible for measurement programming, data processing, and results notifications. Also contains the algorithm submodule.</p></td></tr><tr><th class="confluenceTh"><p>Core/Src/app/active-objects/ao-ppg/</p></th><td class="confluenceTd"><p>PPG active object. Responsible for PPG raw data acquisition.</p></td></tr><tr><th class="confluenceTh"><p>Core/Src/app/active-objects/ao-temperature/</p></th><td class="confluenceTd"><p>Temperature active object. Responsible for skin temperature data acquisition.</p></td></tr><tr><th class="confluenceTh"><p>Core/Inc/</p></th><td class="confluenceTd"><p>Header files for al the files contained in Core/Src/ folder.</p></td></tr><tr><th class="confluenceTh"><p>Middleware/components/bq25150/</p></th><td class="confluenceTd"><p>BQ25150 component (power management IC) drivers.</p></td></tr><tr><th class="confluenceTh"><p>Middleware/components/gd25q128e/</p></th><td class="confluenceTd"><p>GD25Q128E component (external flash memory) drivers.</p></td></tr><tr><th class="confluenceTh"><p>Middleware/components/ism330dhcx/</p></th><td class="confluenceTd"><p>ISM330DHCX component (IMU) drivers. Manufacturer provided (<a class="external-link" href="https://github.com/STMicroelectronics/stm32-ism330dhcx" rel="nofollow"><u>link</u></a>). (Version hash f6d952b).</p></td></tr><tr><th class="confluenceTh"><p>Middleware/components/max30101/</p></th><td class="confluenceTd"><p>MAX30101 component (PPG IC) drivers.</p></td></tr><tr><th class="confluenceTh"><p>Middleware/components/tmp117/</p></th><td class="confluenceTd"><p>TMP117 component drivers.</p></td></tr><tr><th class="confluenceTh"><p>Middleware/domain/</p></th><td class="confluenceTd"><p>Domain measurements. Define the types for each measurement available in the device.</p></td></tr><tr><th class="confluenceTh"><p>Middleware/lib/active-object/</p></th><td class="confluenceTd"><p>Active object engine.</p></td></tr><tr><th class="confluenceTh"><p>Middleware/lib/calendar/</p></th><td class="confluenceTd"><p>Library for epoch to datetime conversion, and vice versa.</p></td></tr><tr><th class="confluenceTh"><p>Middleware/lib/database/</p></th><td class="confluenceTd"><p>Database engine used to store data into the external flash memory.</p></td></tr><tr><th class="confluenceTh"><p>Middleware/lib/debug/</p></th><td class="confluenceTd"><p>Debug utilities to print message to the IDE through SVW.</p></td></tr><tr><th class="confluenceTh"><p>Middleware/lib/lpm/</p></th><td class="confluenceTd"><p>Low-power modes management utility. Manufacturer provided (<a class="external-link" href="https://github.com/STMicroelectronics/STM32CubeWL/tree/main/Utilities/lpm/tiny_lpm" rel="nofollow"><u>link</u></a>). (Version hash 378e461).</p></td></tr><tr><th class="confluenceTh"><p>Middleware/lib/sequencer/</p></th><td class="confluenceTd"><p>Task sequencer utility. Manufacturer provided (<a class="external-link" href="https://github.com/STMicroelectronics/STM32CubeWL/tree/main/Utilities/sequencer" rel="nofollow"><u>link</u></a>). (Version hash 6d27fec).</p></td></tr><tr><th class="confluenceTh"><p>Middleware/lib/timer/</p></th><td class="confluenceTd"><p>Timer server utility for task time-based scheduling. Manufacturer provided (<a class="external-link" href="https://github.com/STMicroelectronics/STM32CubeWL/tree/main/Utilities/timer" rel="nofollow"><u>link</u></a>). (Version hash 6d27fec).</p></td></tr><tr><th class="confluenceTh"><p>Middleware/lib/misc/</p></th><td class="confluenceTd"><p>Miscellanea used by manufacturer provided utilities. Manufacturer provided (<a class="external-link" href="https://github.com/STMicroelectronics/STM32CubeWL/tree/main/Utilities/misc" rel="nofollow"><u>link</u></a>). (Version hash 378e461).</p></td></tr><tr><th class="confluenceTh"><p>Test/</p></th><td class="confluenceTd"><p>Test files based on CppUTest test framework. Contains the test makefile, the tests entry point (all runner), a mirrored folder structure of tested code, and mocks folder.</p></td></tr><tr><th class="confluenceTh"><p>Test/mocks/</p></th><td class="confluenceTd"><p>Contains mocks used during test. Mirrored folder structure of mocked code.</p></td></tr></tbody></table></div><p>All other folders and files in the project are automatically generated by STM32CubeIDE.</p><h1 id="OVC3.2.2.Firmware-Pinout">Pinout</h1><p>View Annex onavital-firmware Project Configuration Report.</p><h1 id="OVC3.2.2.Firmware-STM32Cubeprojectconfiguration">STM32Cube project configuration</h1><p>View Annex onavital-firmware Project Configuration Report.</p><h1 id="OVC3.2.2.Firmware-Bluetooth®GenericAttributeProfile(GATT)">Bluetooth® Generic Attribute Profile (GATT)</h1><h2 id="OVC3.2.2.Firmware-Advertising">Advertising</h2><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="3518905e-3bb1-43a3-af80-885bbcc52463" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>Advertising name</p></th><td class="confluenceTd"><p>ONAV</p></td></tr><tr><th rowspan="3" class="confluenceTh"><p>Advertising data</p></th><td class="confluenceTd"><p>Service data (0x16)</p></td></tr><tr><td class="confluenceTd"><p>Service UUID: 0x2A25</p></td></tr><tr><td class="confluenceTd"><p>Data (serial number): 1YYYYMMDDBXXX</p></td></tr></tbody></table></div><h2 id="OVC3.2.2.Firmware-Profile">Profile</h2><div class="table-wrap"><table data-table-width="1244" data-layout="default" data-local-id="06964cb9-0556-4501-b263-63c16e801be1" class="confluenceTable"><colgroup><col style="width: 248.0px;"/><col style="width: 248.0px;"/><col style="width: 248.0px;"/><col style="width: 363.0px;"/><col style="width: 133.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Type</strong></p></th><th class="confluenceTh"><p><strong>UUID</strong></p></th><th class="confluenceTh"><p><strong>Description</strong></p></th><th class="confluenceTh"><p><strong>Value</strong></p></th><th class="confluenceTh"><p><strong>Permissions</strong></p></th></tr><tr><td class="confluenceTd"><p>Service (public)</p></td><td class="confluenceTd"><p>0000180A-0000-1000-8000-00805F9B34FB</p></td><td class="confluenceTd"><p>Device information service</p></td><td class="confluenceTd"><p>Bluetooth® Device Information Service 1.1 (<a class="external-link" href="https://www.bluetooth.com/specifications/specs/device-information-service-1-1/" rel="nofollow"><u>link</u></a>)</p></td><td class="confluenceTd"><p>-</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (public)</p></td><td class="confluenceTd"><p>00002A29-0000-1000-8000-00805F9B34FB</p></td><td class="confluenceTd"><p>Manufacturer name string</p></td><td class="confluenceTd"><p>Value: ONALABS</p></td><td class="confluenceTd"><p>R</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (public)</p></td><td class="confluenceTd"><p>00002A24-0000-1000-8000-00805F9B34FB</p></td><td class="confluenceTd"><p>Model number string</p></td><td class="confluenceTd"><p>Value: ONAVITAL</p></td><td class="confluenceTd"><p>R</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (public)</p></td><td class="confluenceTd"><p>00002A25-0000-1000-8000-00805F9B34FB</p></td><td class="confluenceTd"><p>Serial number string</p></td><td class="confluenceTd"><p>Value: OVYYYYMMDDBXXX</p><ul><li><p>YYYY: batch year.</p></li><li><p>MM: batch month.</p></li><li><p>DD: batch day.</p></li><li><p>B: batch number.</p></li><li><p>XXX: device id inside batch.</p></li></ul></td><td class="confluenceTd"><p>R</p></td></tr><tr><td class="confluenceTd"><p>Service (public)</p></td><td class="confluenceTd"><p>0000180F-0000-1000-8000-00805F9B34FB</p></td><td class="confluenceTd"><p>Battery service</p></td><td class="confluenceTd"><p>Bluetooth® Battery Service Specification v1.1 (<a class="external-link" href="https://www.bluetooth.com/specifications/specs/battery-service/" rel="nofollow"><u>link</u></a>).</p></td><td class="confluenceTd"><p>-</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (public)</p></td><td class="confluenceTd"><p>00002A19-0000-1000-8000-00805F9B34FB</p></td><td class="confluenceTd"><p>Battery level</p></td><td class="confluenceTd"><p>Struct: batteryLevel<br/>Type: uint8_t<br/>Endianness: little endian</p><ul><li><p>batteryLevel: battery level represented as a percentage from 0 to 100, where 0 percent represents a battery that is fully discharged, and 100 percent represents a battery that is fully charged.</p></li></ul></td><td class="confluenceTd"><p>R, N</p></td></tr><tr><td class="confluenceTd"><p>Service (private)</p></td><td class="confluenceTd"><p>01020304-0506-0708-0900-0A0B0C0D0E0F</p></td><td class="confluenceTd"><p>Measurements service</p></td><td class="confluenceTd"><p>-</p></td><td class="confluenceTd"><p>-</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (private)</p></td><td class="confluenceTd"><p>00112233-4455-6677-8899-00AABBCCDDAA</p></td><td class="confluenceTd"><p>Pulse rate value</p></td><td class="confluenceTd"><p>Struct: id | value | epoch</p><p>Type: uint32_t |uint8_t |uint32_t</p><p>Endianness: little endian</p><ul><li><p>id: measurement identification number. Used to allow the client to detect measures pending for reception (non-consecutive measurements id).</p></li><li><p>value: pulse rate value in bpm.</p></li><li><p>epoch: number of seconds that have elapsed since January 1, 1970 (midnight UTC/GMT), not counting leap seconds (in ISO 8601: 1970-01-01T00:00:00Z) for the measurement.</p></li></ul></td><td class="confluenceTd"><p>R, N</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (private)</p></td><td class="confluenceTd"><p>00112233-4455-6677-8899-00AABBCCDDAB</p></td><td class="confluenceTd"><p>Oxygen saturation value</p></td><td class="confluenceTd"><p>Struct: id | value | epoch</p><p>Type: uint32_t |uint8_t |uint32_t</p><p>Endianness: little endian</p><ul><li><p>id: measurement identification number. Used to allow the client to detect measures pending for reception (non-consecutive measurements id).</p></li><li><p>value: percent oxygen saturation of haemoglobin.</p></li><li><p>epoch: number of seconds that have elapsed since January 1, 1970 (midnight UTC/GMT), not counting leap seconds (in ISO 8601: 1970-01-01T00:00:00Z) for the measurement.</p></li></ul></td><td class="confluenceTd"><p>R, N</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (private)</p></td><td class="confluenceTd"><p>00112233-4455-6677-8899-00AABBCCDDAC</p></td><td class="confluenceTd"><p>Skin temperature value</p></td><td class="confluenceTd"><p>Struct: id | value | epoch</p><p>Type: uint32_t | float32_t |uint32_t</p><p>Endianness: little endian</p><ul><li><p>id: measurement identification number. Used to allow the client to detect measures pending for reception (non-consecutive measurements id).</p></li><li><p>value: skin temperature in Celsius degrees.</p></li><li><p>epoch: number of seconds that have elapsed since January 1, 1970 (midnight UTC/GMT), not counting leap seconds (in ISO 8601: 1970-01-01T00:00:00Z) for the measurement.</p></li></ul></td><td class="confluenceTd"><p>R, N</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (private)</p></td><td class="confluenceTd"><p>00112233-4455-6677-8899-00AABBCCDDAD</p></td><td class="confluenceTd"><p>Number of normal walking steps value</p></td><td class="confluenceTd"><p>Struct: id | value | epoch</p><p>Type: uint32_t | uint16_t |uint32_t</p><p>Endianness: little endian</p><ul><li><p>id: measurement identification number. Used to allow the client to detect measures pending for reception (non-consecutive measurements id).</p></li><li><p>value: number of normal walking steps taken by the user since last steps measurement.</p></li><li><p>epoch: number of seconds that have elapsed since January 1, 1970 (midnight UTC/GMT), not counting leap seconds (in ISO 8601: 1970-01-01T00:00:00Z) for the measurement.</p></li></ul></td><td class="confluenceTd"><p>R, N</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (private)</p></td><td class="confluenceTd"><p>00112233-4455-6677-8899-00AABBCCDDAE</p></td><td class="confluenceTd"><p>Fall status value</p></td><td class="confluenceTd"><p>Struct: id | epoch</p><p>Type: uint32_t |uint32_t</p><p>Endianness: little endian</p><ul><li><p>id: measurement identification number. Used to allow the client to detect measures pending for reception (non-consecutive measurements id).</p></li><li><p>epoch: number of seconds that have elapsed since January 1, 1970 (midnight UTC/GMT), not counting leap seconds (in ISO 8601: 1970-01-01T00:00:00Z) for the falling event.</p></li></ul></td><td class="confluenceTd"><p>R, N</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (private)</p></td><td class="confluenceTd"><p>00112233-4455-6677-8899-00AABBCCDDAF</p></td><td class="confluenceTd"><p>Blood pressure value</p></td><td class="confluenceTd"><p>Struct: id | sys | dia | epoch</p><p>Type: uint32_t |uint8_t | uint8_t | uint32_t</p><p>Endianness: little endian</p><ul><li><p>id: measurement identification number. Used to allow the client to detect measures pending for reception (non-consecutive measurements id).</p></li><li><p>sys: systolic blood pressure in mm/Hg.</p></li><li><p>dia: diastolic blood pressure in mm/Hg.</p></li><li><p>epoch: number of seconds that have elapsed since January 1, 1970 (midnight UTC/GMT), not counting leap seconds (in ISO 8601: 1970-01-01T00:00:00Z) for the falling event.</p></li></ul></td><td class="confluenceTd"><p>R, N</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (private)</p></td><td class="confluenceTd"><p>00112233-4455-6677-8899-00AABBCCDDA1</p></td><td class="confluenceTd"><p>On-demand measurement request by ID</p></td><td class="confluenceTd"><p>Struct: id</p><p>Type: uint32_t</p><p>Endianness: little endian</p><ul><li><p>id: request from the client to the server to resend the measurement with the indicated id.</p></li></ul></td><td class="confluenceTd"><p>R, W</p></td></tr><tr><td class="confluenceTd"><p>Service (private)</p></td><td class="confluenceTd"><p>11020304-0506-0708-0900-0A0B0C0D0E0F</p></td><td class="confluenceTd"><p>Device configuration service</p></td><td class="confluenceTd"><p>-</p></td><td class="confluenceTd"><p>-</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (private)</p></td><td class="confluenceTd"><p>AACA63E0-94D0-45DE-B65E-0D31AA7E47A0</p></td><td class="confluenceTd"><p>Configured active measurements</p></td><td class="confluenceTd"><p>Struct: flags</p><p>Type: uint8_t</p><p>Endianness: little endian</p><ul><li><p>flags: enabled device measurements.<br/>Bit 0: Undefined. For future use.<br/>Bit 1: Undefined. For future use.<br/>Bit 2: Undefined. For future use.<br/>Bit 3: Undefined. For future use.<br/>Bit 4: Undefined. For future use.<br/>Bit 5: Undefined. For future use.<br/>Bit 6: Undefined. For future use.<br/>Bit 7: Undefined. For future use.</p></li></ul></td><td class="confluenceTd"><p>R, W</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (private)</p></td><td class="confluenceTd"><p>6B7E51C7-F76C-4F0C-986A-57D978FEF388</p></td><td class="confluenceTd"><p>Client request</p></td><td class="confluenceTd"><p>Struct: flags</p><p>Type: uint8_t</p><p>Endianness: little endian</p><ul><li><p>flags: request from client to server.<br/>Bit 0: Start on-demand measurement.<br/>Bit 1: Resend measurement by id.<br/>Bit 2: Undefined. For future use.<br/>Bit 3: Undefined. For future use.<br/>Bit 4: Undefined. For future use.<br/>Bit 5: Undefined. For future use.<br/>Bit 6: Undefined. For future use.<br/>Bit 7: Undefined. For future use.</p></li></ul></td><td class="confluenceTd"><p>R, W</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (private)</p></td><td class="confluenceTd"><p>1E07B474-F5C5-49E7-8B47-4F35D710F5B7</p></td><td class="confluenceTd"><p>Server request</p></td><td class="confluenceTd"><p>Struct: flags</p><p>Type: uint8_t</p><p>Endianness: little endian</p><ul><li><p>flags: request from server to client.<br/>Bit 0: Epoch update.<br/>Bit 1: Undefined. For future use.<br/>Bit 2: Undefined. For future use.<br/>Bit 3: Undefined. For future use.<br/>Bit 4: Undefined. For future use.<br/>Bit 5: Undefined. For future use.<br/>Bit 6: Undefined. For future use.<br/>Bit 7: Undefined. For future use.</p></li></ul></td><td class="confluenceTd"><p>R, W, N</p></td></tr><tr><td class="confluenceTd"><p>Characteristic (private)</p></td><td class="confluenceTd"><p>24680D5D-86F7-48DB-A0F1-11BC17E0A11C</p></td><td class="confluenceTd"><p>Epoch update</p></td><td class="confluenceTd"><p>Struct: epoch</p><p>Type: uint32_t</p><p>Endianness: little endian</p><ul><li><p>epoch: current number of seconds that have elapsed since January 1, 1970 (midnight UTC/GMT), not counting leap seconds (in ISO 8601: 1970-01-01T00:00:00Z). Written by the client at the request of the server.</p></li></ul></td><td class="confluenceTd"><p>R, W</p></td></tr></tbody></table></div><h1 id="OVC3.2.2.Firmware-LEDindicator">LED indicator</h1><p>The LED is used as an indicator to communicate the status of the device to the user. The following table shows the different states represented by the device:</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="ed496dfd-b911-4309-aa24-cdc3f3a65cf5" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p><strong>LED state</strong></p></th><th class="confluenceTh"><p><strong>Description</strong></p></th><th class="confluenceTh"><p><strong>Entry conditions</strong></p></th><th class="confluenceTh"><p><strong>Exit conditions</strong></p></th></tr><tr><td data-highlight-colour="#f4f5f7" colspan="4" class="confluenceTd"><p><strong>Battery level indications</strong></p></td></tr><tr><td class="confluenceTd"><p>Brights blue.</p></td><td class="confluenceTd"><p>The device is charging.</p></td><td class="confluenceTd"><ul><li><p>The power cable is connected to the device.</p></li></ul></td><td class="confluenceTd"><ul><li><p>The power cable is disconnected from the device.</p></li></ul><p>OR</p><ul><li><p>The device is fully charged.</p></li></ul></td></tr><tr><td class="confluenceTd"><p>Brights green.</p></td><td class="confluenceTd"><p>The device is fully charged.</p></td><td class="confluenceTd"><ul><li><p>The power cable is connected to the device.</p></li></ul><p>And</p><ul><li><p>The device is fully charged.</p></li></ul></td><td class="confluenceTd"><ul><li><p>The power cable is disconnected from the device.</p></li></ul></td></tr><tr><td class="confluenceTd"><p>Blinking red with a period of 2 seconds.</p></td><td class="confluenceTd"><p>Battery level low.</p></td><td class="confluenceTd"><ul><li><p>The power cable is disconnected from the device.</p></li></ul><p>And</p><ul><li><p>Battery level is low.</p></li></ul></td><td class="confluenceTd"><ul><li><p>The power cable is connected to the device.</p></li></ul><p>Or</p><ul><li><p>The battery is completely discharged.</p></li></ul></td></tr><tr><td data-highlight-colour="#f4f5f7" colspan="4" class="confluenceTd"><p><strong>Measurement indications</strong></p></td></tr><tr><td class="confluenceTd"><p>Blinking alternating blue and red with a period of 2 seconds.</p></td><td class="confluenceTd"><p>The device waits for epoch synchronization.</p></td><td class="confluenceTd"><ul><li><p>The power cable is disconnected from the device.</p></li></ul><p>And</p><ul><li><p>Device has never received an epoch synchronization.</p></li></ul><p>And</p><ul><li><p>The device is shaken or handled.</p></li></ul></td><td class="confluenceTd"><ul><li><p>The epoch is sent to the device.</p></li></ul><p>Or</p><ul><li><p>5 minutes have elapsed since the start of the indication without the epoch having been sent.</p></li></ul><p>Or</p><ul><li><p>The power cable is connected to the device.</p></li></ul><p>Or</p><ul><li><p>The battery is completely discharged.</p></li></ul></td></tr><tr><td class="confluenceTd"><p>Blinking blue with a period of 2 seconds.</p></td><td class="confluenceTd"><p>The device is checking the user potential presence.</p></td><td class="confluenceTd"><ul><li><p>The power cable is disconnected from the device.</p></li></ul><p>And</p><ul><li><p>Device has previously received an epoch synchronization once at least.</p></li></ul><p>And</p><ul><li><p>No user potential presence was detected.</p></li></ul><p>And</p><ul><li><p>The device is shaken or handled.</p></li></ul></td><td class="confluenceTd"><ul><li><p>The user potential presence is detected.</p></li></ul><p>Or</p><ul><li><p>1 minute has elapsed since the start of the indication without a user potential presence detected.</p></li></ul><p>Or</p><ul><li><p>The power cable is connected to the device.</p></li></ul><p>Or</p><ul><li><p>The battery is completely discharged.</p></li></ul></td></tr><tr><td class="confluenceTd"><p>Brights green.</p></td><td class="confluenceTd"><p>User potential presence detected.</p></td><td class="confluenceTd"><ul><li><p>The power cable is disconnected from the device.</p></li></ul><p>And</p><ul><li><p>The user potential presence procedure has finished.</p></li></ul><p>And</p><ul><li><p>The user potential presence is detected.</p></li></ul></td><td class="confluenceTd"><ul><li><p>5 seconds have elapsed since the start of the indication.</p></li></ul><p>Or</p><ul><li><p>The power cable is connected to the device.</p></li></ul><p>Or</p><ul><li><p>The battery is completely discharged.</p></li></ul></td></tr><tr><td class="confluenceTd"><p>Brights green.</p></td><td class="confluenceTd"><p>On-demand measurement in course.</p></td><td class="confluenceTd"><ul><li><p>The power cable is disconnected from the device.</p></li></ul><p>And</p><ul><li><p>The user potential presence was previously detected.</p></li></ul><p>And</p><ul><li><p>An on-demand measurement is requested.</p></li></ul></td><td class="confluenceTd"><ul><li><p>The on-demand measurement has finished.</p></li></ul><p>Or</p><ul><li><p>The power cable is connected to the device.</p></li></ul><p>Or</p><ul><li><p>The battery is completely discharged.</p></li></ul></td></tr></tbody></table></div><h1 id="OVC3.2.2.Firmware-PPGconfiguration">PPG configuration</h1><p>La medición PPG se realiza capturando las señales de los diferentes (verde, rojo, infrarrojo) durante 10 segundos. En el caso de los canales rojo e infrarrojo, solo se enciende uno de los PPGs (PPG 1). Para el canal verde, ambos PPGs son activados (PPG 1 y PPG2). Los datos son extraídos del PPG 1. Todas las mediciones se hacen en paralelo durante el tiempo de muestreo de 10 s.</p><p>Los parámetros de configuración de los PPGs son los siguientes</p><p> </p><div class="table-wrap"><table data-table-width="1000" data-layout="default" data-local-id="772925b9-b7c9-4f04-874f-fd4ceb94ff8d" class="confluenceTable"><colgroup><col style="width: 268.0px;"/><col style="width: 122.0px;"/><col style="width: 122.0px;"/><col style="width: 122.0px;"/><col style="width: 122.0px;"/><col style="width: 122.0px;"/><col style="width: 122.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Parameter</strong></p></th><th class="confluenceTh"><p><strong>PPG1 Green</strong></p></th><th class="confluenceTh"><p><strong>PPG1 Red</strong></p></th><th class="confluenceTh"><p><strong>PPG1 Infrared</strong></p></th><th class="confluenceTh"><p><strong>PPG2 Green</strong></p></th><th class="confluenceTh"><p><strong>PPG2 Red</strong></p></th><th class="confluenceTh"><p><strong>PPG2 Infrared</strong></p></th></tr><tr><td class="confluenceTd"><p>Sampling frequency (Sps)</p></td><td colspan="6" class="confluenceTd"><p>400</p></td></tr><tr><td class="confluenceTd"><p>Sampling average (sample)</p></td><td colspan="6" class="confluenceTd"><p>8</p></td></tr><tr><td class="confluenceTd"><p>SpO2 ADC Range Control (nA)</p></td><td colspan="6" class="confluenceTd"><p>8192</p></td></tr><tr><td class="confluenceTd"><p>Slots</p></td><td class="confluenceTd"><p>LED3</p></td><td class="confluenceTd"><p>LED1</p></td><td class="confluenceTd"><p>LED2</p></td><td class="confluenceTd"><p>LED3</p></td><td class="confluenceTd"><p>-</p></td><td class="confluenceTd"><p>-</p></td></tr><tr><td class="confluenceTd"><p>LED Current Control (mA)</p></td><td class="confluenceTd"><p>25</p></td><td class="confluenceTd"><p>15</p></td><td class="confluenceTd"><p>15</p></td><td class="confluenceTd"><p>25</p></td><td class="confluenceTd"><p>-</p></td><td class="confluenceTd"><p>-</p></td></tr><tr><td class="confluenceTd"><p>LED Pulse Width Control (bits)</p></td><td colspan="6" class="confluenceTd"><p>17</p></td></tr></tbody></table></div><p>With this configuration, next raw PPG signal were captured for a sampling time of 10 seconds.</p><div class="panel" style="background-color: #FFBDAD;border-width: 1px;"><div class="panelContent" style="background-color: #FFBDAD;">
<p>Raw data extracted with the finger and no case.</p>
</div></div><p /><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="green_raw_channel_external_supply.svg" width="525" loading="lazy" src="attachments/22151169/364052550.svg?width=525" data-image-src="attachments/22151169/364052550.svg" data-height="686" data-width="1280" data-unresolved-comment-count="0" data-linked-resource-id="364052550" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="green_raw_channel_external_supply.svg" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/svg+xml" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="c5b96607-ffe1-4f8c-8dd0-7115614e7bff" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="green_raw_channel_battery.svg" width="525" loading="lazy" src="attachments/22151169/364052556.svg?width=525" data-image-src="attachments/22151169/364052556.svg" data-height="686" data-width="1280" data-unresolved-comment-count="0" data-linked-resource-id="364052556" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="green_raw_channel_battery.svg" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/svg+xml" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="1dedf5fa-d6af-43be-a347-8037edc42286" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="red_raw_channel.svg" width="525" loading="lazy" src="attachments/22151169/364052562.svg?width=525" data-image-src="attachments/22151169/364052562.svg" data-height="686" data-width="1280" data-unresolved-comment-count="0" data-linked-resource-id="364052562" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="red_raw_channel.svg" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/svg+xml" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="bba2b085-9f35-450f-b8ae-0197705614e4" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="infrared_raw_channel.svg" width="525" loading="lazy" src="attachments/22151169/364052568.svg?width=525" data-image-src="attachments/22151169/364052568.svg" data-height="686" data-width="1280" data-unresolved-comment-count="0" data-linked-resource-id="364052568" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="infrared_raw_channel.svg" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/svg+xml" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="bff1db3a-980b-4dc6-9959-77f9512cbe89" data-media-type="file"></span><p>Raw data file can be found here <span class="confluence-embedded-file-wrapper"><a class="confluence-embedded-file" href="attachments/22151169/364052574.xlsx" data-nice-type="Microsoft Excel Spreadsheet" data-file-src="/wiki/download/attachments/22151169/PPG%20validation%20on%20finger.xlsx?version=1&amp;modificationDate=1716373065835&amp;cacheVersion=1&amp;api=v2" data-linked-resource-id="364052574" data-linked-resource-type="attachment" data-linked-resource-container-id="22151169" data-linked-resource-default-alias="PPG validation on finger.xlsx" data-mime-type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" data-has-thumbnail="true" data-linked-resource-version="1" data-media-id="e83498c7-3615-45f0-8326-03c35469e7d3" data-media-type="file"><img src="attachments/thumbnails/22151169/364052574" height="250"/></a></span>  .</p><div class="ap-container" id="ap-com.automation-consultants.accloud.approvalmacro__approvalv28552451948964715057">

  <div class="ap-content " id="embedded-com.automation-consultants.accloud.approvalmacro__approvalv28552451948964715057"></div>
  <script nonce="528a568c4bd9f0fff5a3a25050ba0fb5" class="ap-iframe-body-script">
  (function(){
    var data = {
    "addon_key":"com.automation-consultants.accloud.approvalmacro",
    "uniqueKey":"com.automation-consultants.accloud.approvalmacro__approvalv28552451948964715057",
    "key":"approvalv2",
     "moduleType":"dynamicContentMacros",      "moduleLocation":"content",         "cp":"/wiki",
            "general":"",
    "w":"",
    "h":"",
    "url":"https://ac-cloud.com/approvalmacro/v2/macro-page?macroidac=3715c9f0-dd49-11ee-a0ba-71034c7974c5&space_key=ONALABSQMS&page_id=22151169&page_version=15&content_version=15&content_id=22151169&approvers=712020%3A6d4c55b2-bac1-428b-8d23-da56160874f3&title=PPG+configuration&macro.id=6a9ad0e1-46b9-477d-9798-707f51338111&email=true&expiry=true&export=false&stopunapprove=false&nocomment=false&requester=64060eb09ce2cd2c240f8264&xdm_e=https%3A%2F%2Fonalabs.atlassian.net&xdm_c=channel-com.automation-consultants.accloud.approvalmacro__approvalv28552451948964715057&cp=%2Fwiki&xdm_deprecated_addon_key_do_not_use=com.automation-consultants.accloud.approvalmacro&lic=active&cv=1000.0.0-c58bc7260813&traceId=eb5ddbe4f60f519bdaaa4d1419248f1d&spanId=c248b0092e137de4&traceSampled=0&jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiI2MDU0OTY2Yjk0ZDdiOTAwNjkwMmRkMWUiLCJxc2giOiI0MzlkNGNmMTU3MWFkMWZiYzZiZWNjYzFmNjYzNTk5NmJlMTdkOGViZjM0NDk5MzYxN2M4YjhkNWRhMWQ0YTE1IiwiaXNzIjoiNzdjODA3YTAtMmNjNy0zZWVjLWEzNDItOWQzYzYyZjUwZWE0IiwiY29udGV4dCI6e30sImV4cCI6MTc1MTI5NTE3OCwiaWF0IjoxNzUxMjk0OTk4fQ.wZJiSYG2zV5B6dHucc973-e9OQD7blcgJZFlQMVAc7c",
     "contextJwt": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiI2MDU0OTY2Yjk0ZDdiOTAwNjkwMmRkMWUiLCJxc2giOiJjb250ZXh0LXFzaCIsImlzcyI6Ijc3YzgwN2EwLTJjYzctM2VlYy1hMzQyLTlkM2M2MmY1MGVhNCIsImNvbnRleHQiOnsibGljZW5zZSI6eyJhY3RpdmUiOnRydWV9LCJjb25mbHVlbmNlIjp7ImVkaXRvciI6eyJ2ZXJzaW9uIjoidjIifSwibWFjcm8iOnsib3V0cHV0VHlwZSI6Imh0bWxfZXhwb3J0IiwiaGFzaCI6IjZhOWFkMGUxLTQ2YjktNDc3ZC05Nzk4LTcwN2Y1MTMzODExMSIsImlkIjoiNmE5YWQwZTEtNDZiOS00NzdkLTk3OTgtNzA3ZjUxMzM4MTExIn0sInRyYWNpbmciOnsidHJhY2VJZCI6ImViNWRkYmU0ZjYwZjUxOWJkYWFhNGQxNDE5MjQ4ZjFkIiwic3BhbklkIjoiYzI0OGIwMDkyZTEzN2RlNCIsInNhbXBsZWQiOiIwIn0sImNvbnRlbnQiOnsidHlwZSI6InBhZ2UiLCJ2ZXJzaW9uIjoiMTUiLCJpZCI6IjIyMTUxMTY5In0sInNwYWNlIjp7ImtleSI6Ik9OQUxBQlNRTVMiLCJpZCI6IjI3NTI1MTIifX0sInVybCI6eyJkaXNwbGF5VXJsIjoiaHR0cHM6XC9cL29uYWxhYnMuYXRsYXNzaWFuLm5ldFwvd2lraSJ9fSwiZXhwIjoxNzUxMjk1ODk4LCJpYXQiOjE3NTEyOTQ5OTh9.d0MVbAOi31RFdb_hNJN1kvEgbw3mvpzpTJTdHoRpI3A",    "structuredContext": "{\"license\":{\"active\":true},\"confluence\":{\"editor\":{\"version\":\"v2\"},\"macro\":{\"outputType\":\"html_export\",\"hash\":\"6a9ad0e1-46b9-477d-9798-707f51338111\",\"id\":\"6a9ad0e1-46b9-477d-9798-707f51338111\"},\"tracing\":{\"traceId\":\"eb5ddbe4f60f519bdaaa4d1419248f1d\",\"spanId\":\"c248b0092e137de4\",\"sampled\":\"0\"},\"content\":{\"type\":\"page\",\"version\":\"15\",\"id\":\"22151169\"},\"space\":{\"key\":\"ONALABSQMS\",\"id\":\"2752512\"}},\"url\":{\"displayUrl\":\"https://onalabs.atlassian.net/wiki\"}}",
    "contentClassifier":"content",
    "productCtx":"{\"page.id\":\"22151169\",\"macro.hash\":\"6a9ad0e1-46b9-477d-9798-707f51338111\",\"tracing.sampled\":\"0\",\"page.type\":\"page\",\"macro.localId\":\"8223c9f9-47ae-403b-86ea-6e09b3a5e431\",\"approvers\":\"712020:6d4c55b2-bac1-428b-8d23-da56160874f3\",\": = | RAW | = :\":\"requester=64060eb09ce2cd2c240f8264|approvers=712020:6d4c55b2-bac1-428b-8d23-da56160874f3|stopunapprove=false|expiry=true|title=PPG configuration|macroidac=3715c9f0-dd49-11ee-a0ba-71034c7974c5|approverList=[{\\\"displayName\\\":\\\"Andreas Cardona Bonet\\\",\\\"accountId\\\":\\\"712020:6d4c55b2-bac1-428b-8d23-da56160874f3\\\",\\\"profilePicture\\\":\\\"/wiki/aa-avatar/712020:6d4c55b2-bac1-428b-8d23-da56160874f3\\\"}]|email=true|nocomment=false\",\"space.id\":\"2752512\",\"title\":\"PPG configuration\",\"nocomment\":\"false\",\"tracing.traceId\":\"eb5ddbe4f60f519bdaaa4d1419248f1d\",\"expiry\":\"true\",\"tracing.spanId\":\"c248b0092e137de4\",\"macroidac\":\"3715c9f0-dd49-11ee-a0ba-71034c7974c5\",\"user.isExternalCollaborator\":\"false\",\"email\":\"true\",\"requester\":\"64060eb09ce2cd2c240f8264\",\"space.key\":\"ONALABSQMS\",\"content.version\":\"15\",\"page.title\":\"OV C3.2.2. Firmware\",\"macro.body\":\"\",\"macro.truncated\":\"false\",\"content.type\":\"page\",\"output.type\":\"html_export\",\"page.version\":\"15\",\"macro.fragmentLocalId\":\"\",\"content.id\":\"22151169\",\"macro.id\":\"6a9ad0e1-46b9-477d-9798-707f51338111\",\"stopunapprove\":\"false\",\"approverList\":\"[{\\\"displayName\\\":\\\"Andreas Cardona Bonet\\\",\\\"accountId\\\":\\\"712020:6d4c55b2-bac1-428b-8d23-da56160874f3\\\",\\\"profilePicture\\\":\\\"/wiki/aa-avatar/712020:6d4c55b2-bac1-428b-8d23-da56160874f3\\\"}]\",\"editor.version\":\"v2\"}",
    "timeZone":"GB",
    "origin":"https://ac-cloud.com",
    "hostOrigin":"https://onalabs.atlassian.net",
    "sandbox":"allow-downloads allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-scripts allow-same-origin allow-top-navigation-by-user-activation allow-storage-access-by-user-activation",    "pearApp":"true",        "apiMigrations": {
        "gdpr": true
    }
}
;
    if(window.AP && window.AP.subCreate) {
      window._AP.appendConnectAddon(data);
    } else {
      require(['ac/create'], function(create){
        create.appendConnectAddon(data);
      });
    }

    // For Confluence App Analytics. This code works in conjunction with CFE's ConnectSupport.js.
    // Here, we add a listener to the initial HTML page that stores events if the ConnectSupport component
    // has not mounted yet. In CFE, we process the missed event data and disable this initial listener.
    const __MAX_EVENT_ARRAY_SIZE__ = 20;
    const connectAppAnalytics = "ecosystem.confluence.connect.analytics";
    window.connectHost && window.connectHost.onIframeEstablished((eventData) => {
      if (!window.__CONFLUENCE_CONNECT_SUPPORT_LOADED__) {
        let events = JSON.parse(window.localStorage.getItem(connectAppAnalytics)) || [];
        if (events.length >= __MAX_EVENT_ARRAY_SIZE__) {
          events.shift();
        }
        events.push(eventData);
        window.localStorage.setItem(connectAppAnalytics, JSON.stringify(events));
      }
    });

  }());
</script>

</div>
<h1 id="OVC3.2.2.Firmware-Externalflashmemorymap">External flash memory map</h1><div class="table-wrap"><table data-table-width="751" data-layout="default" data-local-id="90b6d52b-8825-453e-9a9d-dc3bc7720161" class="confluenceTable"><colgroup><col style="width: 106.0px;"/><col style="width: 71.0px;"/><col style="width: 135.0px;"/><col style="width: 99.0px;"/><col style="width: 76.0px;"/><col style="width: 264.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Range</strong></p></th><th class="confluenceTh"><p><strong>Size</strong></p></th><th class="confluenceTh"><p><strong>Section</strong></p></th><th class="confluenceTh"><p><strong>Address</strong></p></th><th class="confluenceTh"><p><strong>Size</strong></p></th><th class="confluenceTh"><p><strong>Description</strong></p></th></tr><tr><td class="confluenceTd"><p>0x 00 00 00<br/>0x FF F0 00</p></td><td class="confluenceTd"><p>16 MB</p></td><td class="confluenceTd"><p>Measurements storage</p></td><td class="confluenceTd"><p>0x 00 00 00<br/>to<br/>0x FF F0 00</p></td><td class="confluenceTd"><p>16 MB</p></td><td class="confluenceTd"><p>Non-volatile FIFO that stores all the user measurements not sent or received by Bluetooth LE®.</p></td></tr><tr><td rowspan="2" class="confluenceTd"><p>0x FF F0 00<br/>0x FF FF FF</p></td><td rowspan="2" class="confluenceTd"><p>4 kB</p></td><td rowspan="2" class="confluenceTd"><p>User/session data</p></td><td class="confluenceTd"><p>0x FF F0 00</p></td><td class="confluenceTd"><p>17 B</p></td><td class="confluenceTd"><p>User id (16 B) + CRC (1 B).</p></td></tr><tr><td class="confluenceTd"><p>0x FF F0 10<br/>to<br/>0x FF FF FF</p></td><td class="confluenceTd"><p>3.9 kB</p></td><td class="confluenceTd"><p>Reserved for future use.</p></td></tr></tbody></table></div><h2 id="OVC3.2.2.Firmware-Non-volatileFIFO">Non-volatile FIFO</h2><p>The initialization process for the Non-volatile FIFO section of the memory map involves locating two key memory positions: the <em>head </em>and the <em>tail</em>. These positions play a crucial role in managing order and read/write cycles of the flash memory (EEPROM). As of 28/03/2024, <em>head </em>is designed to point to the first memory block available to be written on, while <em>tail</em> points to the oldest memory block written. </p><p>To achieve this, the EPOCH value of the elements will be analyzed. The EPOCH value is, by default, initialized to the maximum value possible by a four-byte element, and therefore each timestamp captured and stored in the EPOCH section of each value will be lower or equal to this maximum value. Through this default initialization and corresponding nature of the memory (FIFO), a sorted-like structure is achieved. This opened the possibility to use binary search for the minumum value of EPOCH (<em>tail</em>) and maximum value (<em>head</em>). However, the presence of constant duplicates of the maximum value distorted the algorithm, preventing it from functioning correctly. However, modifications have been made and the algorithm's complexity has dropped from O(n) (linear search) to O(log n) (modification of binary search). </p><p>Through this initialization process, as well as finding the necessary pointers, the process also determines if the non-volatile FIFO section is full, empty, or if there has been an error (such as the failure in completing boundry checks).</p><p>Below is a flux diagram of the algorithm:</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="Non-Volatile FIFO Initialization Flux Diagram" width="800" loading="lazy" src="attachments/22151169/364052580.svg?width=800" data-image-src="attachments/22151169/364052580.svg" data-height="1280" data-width="909" data-unresolved-comment-count="0" data-linked-resource-id="364052580" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Non-Volatile FIFO Initialization (1).svg" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/svg+xml" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="c0a771c1-f922-4d51-9124-3de624f728f3" data-media-type="file"></span><p /><h2 id="OVC3.2.2.Firmware-Brainstorming">Brainstorming</h2><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Esta sección está en desarrollo y no es definitiva. Es solo un bloque para recoger las propuestas de implementación de la FIFO en la memoria flash. Una vez escogida la solución, este bloque será eliminado.</p></div></div><p>Existe el problema que con la memoria con pocos datos pendientes de sincronizar (que idealmente será el escenario más común), la complejidad de tiempo de inicializar los punteros de la FIFO (el head y el tail) se torna lineal. Por ello hay que buscar otro método de búsqueda/inicialización. Un método propuesto es marcando los sectores escritos con tal de ir recorriéndolos todos durante la inicialización y ya sí buscar/inicializar linealmente los punteros en el primer y último sectores escritos.</p><p>La memoria tiene 4K sectores (un número importante de sectores y, por lo tanto, operaciones de lectura durante la inicialización). Sin embargo, podemos organizar la memoria siguiendo la estructura lógica de la propia memoria reflejada en la siguiente table y extraída de <span class="confluence-embedded-file-wrapper"><a class="confluence-embedded-file" href="attachments/22151169/364052586.pdf" data-nice-type="PDF Document" data-file-src="/wiki/download/attachments/22151169/DS-00480-GD25Q128E-Rev1.2.pdf?version=1&amp;modificationDate=1716373065876&amp;cacheVersion=1&amp;api=v2" data-linked-resource-id="364052586" data-linked-resource-type="attachment" data-linked-resource-container-id="22151169" data-linked-resource-default-alias="DS-00480-GD25Q128E-Rev1.2.pdf" data-mime-type="application/pdf" data-has-thumbnail="true" data-linked-resource-version="1" data-media-id="b9d5817c-a95d-4217-b668-9b30b61d2969" data-media-type="file"><img src="attachments/thumbnails/22151169/364052586" height="250"/></a></span>.</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="d513029a-d173-4571-96ed-cb699f1d9418" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p><strong>Each device has</strong></p></th><th class="confluenceTh"><p><strong>Each block has</strong></p></th><th class="confluenceTh"><p><strong>Each sector has</strong></p></th><th class="confluenceTh"><p><strong>Each page has</strong></p></th><th class="confluenceTh"><p /></th></tr><tr><td class="confluenceTd"><p>16M</p></td><td class="confluenceTd"><p>64/32K</p></td><td class="confluenceTd"><p>4K</p></td><td class="confluenceTd"><p>256</p></td><td class="confluenceTd"><p>Bytes</p></td></tr><tr><td class="confluenceTd"><p>64K</p></td><td class="confluenceTd"><p>256/128</p></td><td class="confluenceTd"><p>16</p></td><td class="confluenceTd"><p>-</p></td><td class="confluenceTd"><p>pages</p></td></tr><tr><td class="confluenceTd"><p>4K</p></td><td class="confluenceTd"><p>16/8</p></td><td class="confluenceTd"><p>-</p></td><td class="confluenceTd"><p>-</p></td><td class="confluenceTd"><p>sectors</p></td></tr><tr><td class="confluenceTd"><p>256/512</p></td><td class="confluenceTd"><p>-</p></td><td class="confluenceTd"><p>-</p></td><td class="confluenceTd"><p>-</p></td><td class="confluenceTd"><p>blocks</p></td></tr></tbody></table></div><p>Se podría realizar un marcado (header) de los bloques, de los sectores y de las páginas. Ese header, por ejemplo, tendría como miembros (ignorar los nombres usados):</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: c; gutter: false; theme: Confluence" data-theme="Confluence">#define MAX_EPOCH UINT32_MAX
#define MIN_EPOCH UINT32_MIN

typedef enum {
  Memory_Status_Erased = 0xFFFFFFFFU,
  Memory_Status_Data_Pending = 0xFFFFFF00U,
  Memory_Status_No_Data_Pending = 0xFFFF0000U,
} Memory_Status_t;

typedef uint32_t Epoch_t;

typedef struct {
  Memory_Status_t status;
  Epoch_t init_epoch;
} Memory_Header_t;</pre>
</div></div><p>Podríamos recorrer los 256 bloques (que no son muchas operaciones de lectura) y buscar el bloque con datos aún pendientes de ser sincronizados con el epoch más antiguo (ahí buscaríamos el tail) y el buscar el bloque con datos aún pendientes de sincronizados con el epoch más reciente (ahí buscaríamos el head).</p><p>Dentro de cada bloque repetiríamos la misma operación para los sectores, y dentro de cada sector repetiríamos la misma operación para las páginas para, finalmente, de manera lineal, buscar el tail y head dentro de la página.</p><p>En el peor caso, recorreríamos todos los bloques (256), de esos bloques recorreríamos todos los sectores de dos de ellos (16 sectores/bloque), de esos sectores recorreríamos todas las páginas de 2 de ellos (16 páginas/sector), y de esas páginas recorreríamos todos los elementos de la fifo de 2 de ellas (6 elementos por página (32 bytes por elemento)). El total de lecturas sería de:</p><p>256 bloques * 1 lectura/bloque + 2 bloques * 16 sectores/bloque * 1 lectura/sector + 2 sectores * 16 páginas/sector * 1 lectura/página + 2 páginas * 6 elementos/página * 1 lectura/elemento = 332 lecturas.</p><p>Habría circunstancias que reducirían el número de lecturas como una página, sector o bloque no completamente escrita.</p><h3 id="OVC3.2.2.Firmware-Analysisoffirstoption+additionalproposals">Analysis of first option + additional proposals</h3><p>Upon a first examination, it is important to note that the first proposal may potentially genere some data segmentation and memory alignment issues. On top of that, for each page in the memory, at least one NVF_Element_t will be unable to be allocated. Although the proposal hasn’t been discussed in person, I assume that the Memory Header structure is applied to all memory levels. In a way, the block diagram would be the following: </p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="Proposal 1 Analysis.svg" width="500" loading="lazy" src="attachments/22151169/364052592.svg?width=500" data-image-src="attachments/22151169/364052592.svg" data-height="822" data-width="1280" data-unresolved-comment-count="0" data-linked-resource-id="364052592" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Proposal 1 Analysis.svg" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/svg+xml" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="5a616643-32fc-4462-8212-ef1ae6417597" data-media-type="file"></span><p>Given that we have 4095 sectors for the NVF, we would have 4095 sectors * 16 pages/sector * 15 elements/page = 982800 elements. This value compared to the previous (1048320), indicates that we have lost the ability to store  65520 elements. That would translate to around 1MB (nElements * Bytes/Element).</p><p>The main reason to allocate this much memory is to have a low number of read cycles, and attempt a divide-and-conquer strategy to “segmentate” the search area. Given a worse case scenario, we would have:</p><p>256 Blocks * 1 Read/Block + 2 Blocks * [16 Sectors/Block * 1 Read/Sector] + 2 Sectors * [16 Pages/Sector * 1 Read/Pages] + 2 Pages * [15 elements/Page * 1 Read/Element] = 256 Reads +  32 Reads + 32 Reads + 30 Reads = 350 Reads.</p><p>This data can be summarized and added to a table to add as a reference point: </p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="97446d1a-f20d-4ec7-aff0-272f35a29aa2" class="confluenceTable"><colgroup><col style="width: 90.0px;"/><col style="width: 147.0px;"/><col style="width: 163.0px;"/><col style="width: 220.0px;"/><col style="width: 140.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Proposal</strong></p></th><th class="confluenceTh"><p><strong>Lost Memory Capacity</strong></p></th><th class="confluenceTh"><p><strong>Number of Reads (WCS)</strong></p></th><th class="confluenceTh"><p><strong>Pros</strong></p></th><th class="confluenceTh"><p><strong>Cons</strong></p></th></tr><tr><td class="confluenceTd"><p>1</p></td><td class="confluenceTd"><p>&gt;1MB | &gt;65520 elements</p></td><td class="confluenceTd"><p>350</p></td><td class="confluenceTd"><p>Low number of reads </p></td><td class="confluenceTd"><p>Big hit in memory capacity, possible complications in data alignment and segmentation.</p></td></tr></tbody></table></div><p>There are two more possible proposals: a more complex-one based on the paper <a class="external-link" href="https://www.researchgate.net/publication/220566667_Algorithms_and_Data_Structures_for_Flash_Memories" rel="nofollow">about data structures and algorithms in Flash Memories</a>, and a more basic-type based on the current implementation present in Onasport.</p><p>Due to time constraints, we will begin with the more simple approach, to at least have one more proposal to test against.</p><p>The minimum erase unit is a sector. If we assign a sector, and see it as an independent stack-like structure, we can store the elements in the designated sector, restrict the sector (like the static one used for user information, among others), and as a result would only have to linearly search that sector. Although time complexity is O(n), the reduced size of the sector in comparison to the whole memory (by a factor of 4K) makes it an assumable cost. </p><p>The most important aspect would be to create a data structure that occupies the designated space correctly, and allows us to be efficient. Since we are going to be using a sector, we know we have 4KB available. Given this, the following structure is proposed:</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="Data Structure for Propsal 2" width="500" loading="lazy" src="attachments/22151169/364052598.svg?width=500" data-image-src="attachments/22151169/364052598.svg" data-height="471" data-width="1280" data-unresolved-comment-count="0" data-linked-resource-id="364052598" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Data Structure for Propsal 1.svg" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/svg+xml" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="33fc7e55-91f0-4d8d-95cf-b756b1b8de2a" data-media-type="file"></span><p>A 10 Byte Structure will allow us to have 409 of these structures in our stack. An issue that may occur is the erase cycles. According to the documentations, we have 100,000 cycles. That would mean that the reliable span of our structure would add up to 40.9 million pairs of head-tail addresses.</p><p>The flux diagram of this second proposal would be the following. We should suppose that all attributes of the structure are initialized to a determined value in case of being empty:</p><p /><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="Proposal 2" width="300" loading="lazy" src="attachments/22151169/364052604.svg?width=300" data-image-src="attachments/22151169/364052604.svg" data-height="200" data-width="250" data-unresolved-comment-count="0" data-linked-resource-id="364052604" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Proposal 2.svg" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/svg+xml" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="f2b45703-68bb-468b-a874-a04167aa3e77" data-media-type="file"></span><p>  </p><p>We can the update the previous table:</p><p /><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="1845280b-4725-412d-8acc-29fa58aff31c" class="confluenceTable"><colgroup><col style="width: 87.0px;"/><col style="width: 198.0px;"/><col style="width: 202.0px;"/><col style="width: 133.0px;"/><col style="width: 140.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Proposal</strong></p></th><th class="confluenceTh"><p><strong>Lost Memory Capacity</strong></p></th><th class="confluenceTh"><p><strong>Number of Reads (WCS)</strong></p></th><th class="confluenceTh"><p><strong>Pros</strong></p></th><th class="confluenceTh"><p><strong>Cons</strong></p></th></tr><tr><td class="confluenceTd"><p>1</p></td><td class="confluenceTd"><p>&gt;1MB | &gt;65520 elements</p></td><td class="confluenceTd"><p>350</p></td><td class="confluenceTd"><p>Low number of reads </p></td><td class="confluenceTd"><p>Big hit in memory capacity, possible complications in data alignment and segmentati</p></td></tr><tr><td class="confluenceTd"><p>2</p></td><td class="confluenceTd"><p>4KB | 255 elements</p></td><td class="confluenceTd"><p>490</p></td><td class="confluenceTd"><p>No large loss of memory capacity, relatively low number of reads</p></td><td class="confluenceTd"><p>Time complexity of search algorithm (linear search - O(n)), programable/erasable cycles.</p></td></tr></tbody></table></div><h1 id="OVC3.2.2.Firmware-BLEsecurity">BLE security</h1><h2 id="OVC3.2.2.Firmware-Pairingandbonding">Pairing and bonding</h2><p>There are two main security scenarios that the Bluetooth LE standard addresses: Passive eavesdropping and man-in-the-middle (MITM).</p><p>Passive eavesdropping is where a third party listens in to the data being exchanged between two paired devices. This security concern is avoided encrypting the data being exchanged by means of a previous pairing process that generates an encryption key previous to the data exchange. (pairing) </p><p>MITM (i.e. active eavesdropping) is a process by which a third party impersonates the initiator and responder, in order to trick them into connecting to it. The BLE central and peripheral devices will connect to the malicious party which intercepts all data being sent between them. The malicious party can also insert false data or remove data before it reaches the recipient. This security concern is avoided by means of authentication performed during paring process (bonding).</p><p>This is solved using the Secure Simple Pairing (SSP) process and there are four modes:</p><ul><li><p>Just works</p></li><li><p>Passkey entry</p></li><li><p>Numeric comparison</p></li><li><p>Out of band</p></li></ul><p>Just works mode is discarded as it does not offer MITM protection (as there is no device authentication (bonding)). Out of band mode (which would be the most secure option) is also discarded as it requires paring communication in another bandwidth, e.g. NFC, and the device does not have this other communication interface. In the case of the Numeric comparison method, both the mobile and the device display a 6-digit number and the user must simply confirm that the number matches. Since the device does not have a display, this method is discarded.</p><p>The last method, Passkey entry, requires a 6-digit numeric code to be entered at the time of pairing. Even if there were a man-in-the-middle, the chance of the attacker guessing the pairing code of 1 in a million (10<sup>6</sup>). This is the chosen option.</p><ul class="decision-list"><li>The Passkey Entry matching process is implemented.</li></ul><p>The Passkey Entry method has different variants depending on the scenario and interface elements of the device. The ideal case would be one in which the device generates a random 6-digit number, displays it on the screen to the user, and the user must perform the pairing with that digit. However, this is not possible because the device does not have a screen to display the digit. Then there is the second scenario in which the digit is fixed. Within this scenario there are two sub-scenarios: one in which the digit is the same for all devices, and one in which each device has a unique digit. The first sub-scenario is the one with the least protection since if the attacker knows the digit (either because it has discovered it by brute force, because it is in the instruction manual, or any other reason) the connection will be secure as long as the pairing procedure is performed in a secure environment. If the pairing is performed in the presence of the attacker, the attacker will be able to make use of the MITM technique. However, if the attacker is not present during the pairing process, the pairing is performed securely and the connection will henceforth remain secure (since the pairing is required only once).</p><p>The second scenario is that it offers greater security since each device has a unique number and, therefore, even if the attacker gets hold of the code of a device (because he has bought it, for example) the chances of successfully attacking other devices are reduced to 1 in a million. This would be the ideal scenario with the actual device, but it includes two additional steps in the production of the device: 1) program in a flash memory space the unique pairing code (which would not have a big impact since the serial number of the device and the hardware version should already be flashed in the flash memory), and 2) add in each package a document with the code of each device (and save it in our database in case the user loses the code and contacts us, or for the scenario in which gateways are used and they need to know the codes).</p><p>This last method is the one recommended by the Firmware and Software Department, and the one implemented.</p><h2 id="OVC3.2.2.Firmware-Pairingprocess">Pairing process</h2><p>The bonding process begins when the client (mobile device) requests to read or write a protected characteristic. Then, the server (Onavital) initiates the bonding process. The server requests to the client to provide a 6-digit number for pairing. This pairing code is stored and retrieved from the platform and displayed on the smartphone’s screen for the user to enter. The pairing code is also stored in the mobile device's clipboard to facilitate the process. This is a process fully managed by the mobile phone's operating system, where the application cannot intervene. The user must enter the pairing code. Once the correct pairing code is successfully entered, the corresponding keys are exchanged and stored to complete the bonding process. If the correct pairing code is not provided, the bonding process is not completed.</p><h2 id="OVC3.2.2.Firmware-Over-the-airupdate">Over-the-air update</h2><p>El dispositivo incorpora una funcionalidad de actualización por-el-aire (OTA). Esto permite al dispositivo poder recibir actualizaciones de firmware que añadan nuevas funcionalidades o que corrijan errores. El archivo de actualización, correspondiente a una imagen del firmware a instalar dentro del microcontrolador del dispositivo, se envía de la aplicación móvil Onavital+ al propio dispositivo mediante la comunicación Bluetooth Low Energy®. Para asegurar que en el dispositivo solo se instala actualizaciones provenientes de Onalabs, que ningún atacante puede acceder a los contenidos de la actualización si intercepta el archivo, y que en el caso de recibirse un archivo corrompido (ya sea por paquetes perdidos durante la comunicación inalámbrica o por la modificación expresa de un atacante) no se instale el archivo recibido, el dispositivo debe de proveer funcionalidades de encriptación que cubran los aspectos de seguridad de autenticidad, confidencialidad e integridad, respectivamente. El siguiente apartado describe la aproximación seguida por Onalabs para implementar el OTA teniendo en cuenta los aspectos de seguridad anteriormente citados. Dicha aproximación está basada en la solución basada por STMicroelectronics X-CUBE-SBSFU y STM32CubeWB.</p><h3 id="OVC3.2.2.Firmware-Encriptaciónyfirmaselasactualizaciones">Encriptación y firma se las actualizaciones</h3><p>El componente STM32WB5MM es un microcontrolador de doble núcleo que contiene un Cortex-M4 encargado de ejecutar la aplicación de usuario y un Cortex-M0+ encargado de la gestión del stack de la comunicación inalámbrica. El núcleo Cortex-M4 dispone de un módulo de encriptación, mientras que el núcleo Cortex-M0+ dispone de un Cryptographic Key Storage (CKS). El módulo criptográfico permite des/encriptar datos con claves AES de 128 y 256 bits supporting chaining modes ECB, CBC, CTR, GCM, GMAC, CCM. Una de las funcionalidades de seguridad más interesantes del STM32WB5MM es que la memoria del núcleo Cortex-M0+ no es accesible desde el núcleo Cortex-M4. De este modo, las claves almacenadas en el CKS no son accesibles desde la aplicación de usuario. El núcleo Cortex-M0+ puede, bajo petición de la aplicación de usuario que se ejecuta en el núcleo Cortex-M4, cargar en el módulo de encriptación vía hardware alguna de las claves almacenadas en el CKS para realizar las operaciones de des/encriptaciones pertinentes. De este modo, la aplicación de usuario puede realizar operaciones de des/encriptación sin tener acceso a las claves almacenadas en ningún momento.</p><h4 id="OVC3.2.2.Firmware-Autenticidad">Autenticidad</h4><p>Para asegurar que solo se instalan actualizaciones provenientes de Onalabs, el dispositivo debe cubrir el aspecto de seguridad ligado a autenticidad. Para ello, la solución hace uso de claves de encriptación asimétricas ECDSA.</p><p>Cuando una nueva de versión es compilada, la imagen binaria resultante es firmada con una clave privada. La firma se incorpora a un encabezado adjuntado al inicio del archivo. Esta clave usada para generar la firma solo debe de estar disponible para personal autorizado en Onalabs y nunca debe de ser comprometida. El microcontrolador, al recibir la actualización, desencripta el archivo de actualización (como se describe en el siguiente apartado) y comprueba la firma del archivo mediante una clave pública almacenada en la aplicación de usuario. No hace falta almacenar dicha clave pública en el CKS puesto que no supone un problema de seguridad que terceros puedan tener acceso a esta clave pública ya que únicamente sirve para validar una firma (realizada con la clave privada). En ningún caso esta firma pública permite firmar archivos de actualización como Onalabs.</p><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>La clave privada no debe de ser expuesta puesto que un atacante podría hacerse pasar por Onalabs si se hace con ella.<br/>Que la clave pública sea expuesta no comporta ningún problema de seguridad puesto que solo sirve para verificar la autenticidad de la firma y no se puede reconstruir la clave privada a partir de ella.</p></div></div><h4 id="OVC3.2.2.Firmware-Confidencialidad">Confidencialidad</h4><p>El archivo de actualización, una vez compilado en Onalabs, es encriptado mediante una clave simétrica AES de 128 bits. Esto es, se necesita la misma clave tanto para encriptar como para desencriptar. Esta clave, puesto que permitiría tener acceso a los contenidos de los archivos de actualización lanzado por Onalabs, sí debe permanecer a buen recaudo y por ello se almacena en el CKS del núcleo Cortex-M0+.</p><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>La clave de encriptación no debe de ser expuesta puesto que un atacante podría desencriptar los archivos de actualización y tener acceso al contenido del mismo pudiendo hacer ingeniería inversa al firmware.</p></div></div><h4 id="OVC3.2.2.Firmware-Integridad">Integridad</h4><p>Para asegurar que ningún dato del archivo ha sido modificado por errores en la comunicación o por modificación expresa de un atacante, durante el proceso de compilación y firma, se calcula un hash SHA256 a partir de la información contenida en el archivo de actualización y se inserta en el encabezado adjuntado al inicio del archivo junto con a la firma. Al recibir el archivo de actualización y desencriptarlo, el microcontrolador calcula de nuevo el hash SHA256 y lo compara con el valor insertado en el encabezado. Si coincide, considera que el contenido del archivo de actualización no ha sido alterado y procede a realizar la comprobación de autenticidad.</p><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Este proceso no comporta el uso de ningún tipo de clave de seguridad que requiera ser protegida.</p></div></div><h3 id="OVC3.2.2.Firmware-Securebootandsecurefirmwareupdate">Secure boot and secure firmware update</h3><p>El SBSFU es el responsable de desencriptar el archivo de actualización, comprobar su integridad mediante el hash SHA256, y validar su autenticidad. La aplicación SBSFU es una aplicación proveída y mantenida por STMicroelectronincs, el fabricante del microcontrolador, dentro del paquete de expansión X-CUBE-SBSFU. El SBSFU es configurable en términos de esquema de encriptación, número de ranuras para aplicaciones de usuario, y cargador de firmware.</p><h4 id="OVC3.2.2.Firmware-Esquemadeencriptación">Esquema de encriptación</h4><p>En el SBSFU pueden configurarse hasta 4 esquemas de encriptación, indicados en la siguiente imagen extradía de la Tabla 3 del documento UM2262.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240214-172017.png" width="760" loading="lazy" src="attachments/22151169/364052610.png?width=760" data-image-src="attachments/22151169/364052610.png" data-height="787" data-width="1526" data-unresolved-comment-count="0" data-linked-resource-id="364052610" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240214-172017.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="cabb7534-0094-4f93-aaa7-ced54104b59a" data-media-type="file"></span><p>El esquema seleccionado es el primero, Asymmetric with AES encryption, y es el descrito en los apartados anteriores. Este esquema permite ocultar el contenido del archivo de actualización del firmware (confidencialidad), permite firmar el archivo con una clave asimétrica (autenticidad) considerada una solución más segura que el uso de claves simétricas, y comprueba la integridad del contenido mediante un SHA256 (integridad).</p><h4 id="OVC3.2.2.Firmware-Númeroderanuras">Número de ranuras</h4><p>El SBSFU mapea en la memoria del microcontrolador dos slots: una para la aplicación activa y otra para la aplicación descargada. El slot con la aplicación activa, como su nombre indica, aloja la aplicación de usuario que se esté ejecutando en el microcontrolador. Por otro lado, el segundo slot aloja la imagen de la actualización enviada al microcontrolador. Cuando el SBSFU comprueba la integridad y autenticidad de la actualización y las da por buenas, mueve la aplicación descargada del slot 2 al 1. El SBSFU tiene la capacidad de, en el caso de detenerse la migración del slot 2 al 1 por un corte en la alimentación, de retomar la migración al reestablecerse la alimentación.</p><h4 id="OVC3.2.2.Firmware-Cargadordefirmware">Cargador de firmware</h4><p>En la memoria del microcontrolador también se almacena una región para almacenar una aplicación cuyo único propósito es recibir el archivo de actualización. En este caso la aplicación es una creada y mantenida por STMicroelectronics en los paquetes X-CUBE-SBSFU y STM32CubeWB llamada BLE_ota. Esta aplicación configura una serie de servicios y características preparados para iniciar y gestionar el envío del archivo de actualización de la aplicación móvil al dispositivo utilizando el procedimiento establecido por STMicroelectronics. Por defecto, después de un reinicio, el SBSFU carga la aplicación de usuario una vez validada. Por ello, la aplicación de usuario es la responsable de iniciar la aplicación BLE_ota. Con este objetivo, la aplicación de usuario, siguiendo las indicaciones de STMicroelectronics, publica una característica específica para solicitar el inicio de la aplicación BLE_ota e iniciar el envío del archivo de actualización. A continuación, se describen el proceso de actualización, así como los diferentes servicios y características que participan en este proceso, también disponible en el documento AN5247 del fabricante.</p><h5 id="OVC3.2.2.Firmware-Envíodelarchivodeactualización">Envío del archivo de actualización</h5><p>Para poder hacer compatible la aplicación de usuario con el procedimiento de actualización de STMicroelectronics, la aplicación de usuario debe de hacer un advertising de datos del fabricante específico y publicar una característica específica para gestionar la petición de inicio del proceso de actualización OTA.</p><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Hacer que la aplicación sea compatible con el procedimiento de STMicroelectronics tiene como beneficios un importante ahorro en recursos en desarrollo al utilizar una aplicación OTA ya desarrollada y mantenida por el fabricante, y la compatibilidad con sus aplicaciones móviles de actualización remota. El código de estas aplicaciones móviles es abierto, por lo que también agiliza el desarrollo de la gestión de la actualización OTA en la aplicación móvil Onavital.</p></div></div><h6 id="OVC3.2.2.Firmware-Advertisingdataycaracterísticasdelaaplicacióndeusuario">Advertising data y características de la aplicación de usuario</h6><p>La siguiente información indica todo lo relativo al proceso de actualización OTA. No incluye otros servicios o características publicados, así como otros datos de advertising, propios de la aplicación de usuario.</p><p>User application AD data:</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="f3a1f0c3-5d81-425b-8291-12910d949f4b" class="confluenceTable"><colgroup><col style="width: 161.0px;"/><col style="width: 183.0px;"/><col style="width: 194.0px;"/><col style="width: 218.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>AD field name</strong></p></th><th class="confluenceTh"><p><strong>AD type</strong></p></th><th class="confluenceTh"><p><strong>AD length</strong></p></th><th class="confluenceTh"><p><strong>Record size</strong></p></th></tr><tr><td class="confluenceTd"><p>MANUF_SPECIFIC</p></td><td class="confluenceTd"><p>0xFF</p></td><td class="confluenceTd"><p>13</p></td><td class="confluenceTd"><p>14</p></td></tr></tbody></table></div><p>User application AD data manufacturer specific field:</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="4cbea257-ef5c-4399-80b5-299dfc8f3ba9" class="confluenceTable"><colgroup><col style="width: 161.0px;"/><col style="width: 183.0px;"/><col style="width: 125.0px;"/><col style="width: 287.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Bytes(s)</strong></p></th><th class="confluenceTh"><p><strong>Name</strong></p></th><th class="confluenceTh"><p><strong>Value</strong></p></th><th class="confluenceTh"><p><strong>Comment</strong></p></th></tr><tr><td class="confluenceTd"><p>0</p></td><td class="confluenceTd"><p>Length</p></td><td class="confluenceTd"><p>8</p></td><td class="confluenceTd"><p>-</p></td></tr><tr><td class="confluenceTd"><p>1</p></td><td class="confluenceTd"><p>Type</p></td><td class="confluenceTd"><p>0xFF</p></td><td class="confluenceTd"><p>Manufacturer specific</p></td></tr><tr><td class="confluenceTd"><p>2</p></td><td class="confluenceTd"><p>Version</p></td><td class="confluenceTd"><p>0x01</p></td><td class="confluenceTd"><p>-</p></td></tr><tr><td class="confluenceTd"><p>3</p></td><td class="confluenceTd"><p>ID</p></td><td class="confluenceTd"><p>0x00 – 0xFF</p></td><td class="confluenceTd"><p>0x86 for OTA loader</p></td></tr><tr><td class="confluenceTd"><p>4</p></td><td rowspan="2" class="confluenceTd"><p>Feature group A</p></td><td rowspan="4" class="confluenceTd"><p>Bit fields</p></td><td rowspan="2" class="confluenceTd"><p>Reserved</p></td></tr><tr><td class="confluenceTd"><p>5</p></td></tr><tr><td class="confluenceTd"><p>6</p></td><td rowspan="2" class="confluenceTd"><p>Feature group B</p></td><td rowspan="2" class="confluenceTd"><p>0x20 for OTA enabled device</p></td></tr><tr><td class="confluenceTd"><p>7</p></td></tr><tr><td class="confluenceTd"><p>8 – 13</p></td><td class="confluenceTd"><p>Public device address</p></td><td class="confluenceTd"><p>Bytes</p></td><td class="confluenceTd"><p>Optional</p></td></tr></tbody></table></div><p>User application AD data manufacturer specific field group B features:</p><div class="table-wrap"><table data-table-width="380" data-layout="default" data-local-id="a1dfa823-7b26-422f-be49-bc4c276e48f4" class="confluenceTable"><colgroup><col style="width: 84.0px;"/><col style="width: 296.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Bit(s)</strong></p></th><th class="confluenceTh"><p><strong>Field</strong></p></th></tr><tr><td class="confluenceTd"><p>15</p></td><td class="confluenceTd"><p>Reserved</p></td></tr><tr><td class="confluenceTd"><p>14</p></td><td class="confluenceTd"><p>Thread support</p></td></tr><tr><td class="confluenceTd"><p>13</p></td><td class="confluenceTd"><p>OTA reboot request</p></td></tr><tr><td class="confluenceTd"><p>12 – 0</p></td><td class="confluenceTd"><p>Reserved</p></td></tr></tbody></table></div><p>User application service and characteristic:</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="69c06d8e-6687-46d8-9d76-84c536f81a8d" class="confluenceTable"><colgroup><col style="width: 151.0px;"/><col style="width: 151.0px;"/><col style="width: 60.0px;"/><col style="width: 219.0px;"/><col style="width: 174.0px;"/></colgroup><tbody><tr><td data-highlight-colour="#f4f5f7" colspan="5" class="confluenceTd"><p><strong>Service</strong></p></td></tr><tr><td rowspan="2" class="confluenceTd"><p>Device requests status</p></td><td class="confluenceTd"><p>Function</p></td><td colspan="3" class="confluenceTd"><p>Service that aggregates device status characteristics as well as requests from the server to the client and vice versa characteristics. STMicroelectronics allows to incorporate the characteristic to start the BLE_ota application in any service.</p></td></tr><tr><td class="confluenceTd"><p>UUID</p></td><td colspan="3" class="confluenceTd"><p>11020304-0506-0708-0900-0A0B0C0D0E0F</p></td></tr><tr><td data-highlight-colour="#f4f5f7" colspan="5" class="confluenceTd"><p><strong>Characteristics</strong></p></td></tr><tr><td rowspan="7" class="confluenceTd"><p>Reboot request</p></td><td class="confluenceTd"><p>Function</p></td><td colspan="3" class="confluenceTd"><p>Request device reboot for OTA application</p></td></tr><tr><td class="confluenceTd"><p>Size</p></td><td colspan="3" class="confluenceTd"><p>3</p></td></tr><tr><td class="confluenceTd"><p>Mode</p></td><td colspan="3" class="confluenceTd"><p>Write</p></td></tr><tr><td class="confluenceTd"><p>UUID</p></td><td colspan="3" class="confluenceTd"><p>0000FE11-8E22-4541-9D4C-21EdAE82ED19</p></td></tr><tr><td rowspan="3" class="confluenceTd"><p>Fields</p></td><td class="confluenceTd"><p>0</p></td><td class="confluenceTd"><p>Boot mode</p></td><td class="confluenceTd"><p>0x00 User application</p><p>0x01 OTA application</p></td></tr><tr><td class="confluenceTd"><p>1</p></td><td class="confluenceTd"><p>Sector index</p></td><td class="confluenceTd"><p>-</p></td></tr><tr><td class="confluenceTd"><p>2</p></td><td class="confluenceTd"><p>Number of sectors to erase</p></td><td class="confluenceTd"><p>0x00 – 0xFF</p></td></tr></tbody></table></div><h6 id="OVC3.2.2.Firmware-AdvertisingdataycaracterísticasdelaaplicaciónBLE_ota">Advertising data y características de la aplicación BLE_ota</h6><p>La siguiente información indica todo lo relativo al proceso de actualización OTA. No incluye otros servicios o características publicados, así como otros datos de advertising, propios de la aplicación BLE_ota.</p><p>BLE_ota AD data:</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="b52a189d-c087-41b5-bb35-07a7d769d327" class="confluenceTable"><colgroup><col style="width: 161.0px;"/><col style="width: 183.0px;"/><col style="width: 194.0px;"/><col style="width: 218.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>AD field name</strong></p></th><th class="confluenceTh"><p><strong>AD type</strong></p></th><th class="confluenceTh"><p><strong>AD length</strong></p></th><th class="confluenceTh"><p><strong>Record size</strong></p></th></tr><tr><td class="confluenceTd"><p>MANUF_SPECIFIC</p></td><td class="confluenceTd"><p>0xFF</p></td><td class="confluenceTd"><p>13</p></td><td class="confluenceTd"><p>14</p></td></tr></tbody></table></div><p>BLE_ota  AD data manufacturer specific field:</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="8327ec86-6c0e-4566-bf54-f544ddab75be" class="confluenceTable"><colgroup><col style="width: 161.0px;"/><col style="width: 183.0px;"/><col style="width: 125.0px;"/><col style="width: 287.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Bytes(s)</strong></p></th><th class="confluenceTh"><p><strong>Name</strong></p></th><th class="confluenceTh"><p><strong>Value</strong></p></th><th class="confluenceTh"><p><strong>Comment</strong></p></th></tr><tr><td class="confluenceTd"><p>0</p></td><td class="confluenceTd"><p>Length</p></td><td class="confluenceTd"><p>8</p></td><td class="confluenceTd"><p>-</p></td></tr><tr><td class="confluenceTd"><p>1</p></td><td class="confluenceTd"><p>Type</p></td><td class="confluenceTd"><p>0xFF</p></td><td class="confluenceTd"><p>Manufacturer specific</p></td></tr><tr><td class="confluenceTd"><p>2</p></td><td class="confluenceTd"><p>Version</p></td><td class="confluenceTd"><p>0x01</p></td><td class="confluenceTd"><p>-</p></td></tr><tr><td class="confluenceTd"><p>3</p></td><td class="confluenceTd"><p>ID</p></td><td class="confluenceTd"><p>0x00 – 0xFF</p></td><td class="confluenceTd"><p>0x86 for OTA loader</p></td></tr><tr><td class="confluenceTd"><p>4</p></td><td rowspan="2" class="confluenceTd"><p>Feature group A</p></td><td rowspan="4" class="confluenceTd"><p>Bit fields</p></td><td rowspan="2" class="confluenceTd"><p>Reserved</p></td></tr><tr><td class="confluenceTd"><p>5</p></td></tr><tr><td class="confluenceTd"><p>6</p></td><td rowspan="2" class="confluenceTd"><p>Feature group B</p></td><td rowspan="2" class="confluenceTd"><p>0x20 for OTA enabled device</p></td></tr><tr><td class="confluenceTd"><p>7</p></td></tr><tr><td class="confluenceTd"><p>8 – 13</p></td><td class="confluenceTd"><p>Public device address</p></td><td class="confluenceTd"><p>Bytes</p></td><td class="confluenceTd"><p>Optional</p></td></tr></tbody></table></div><p>BLE_ota AD data manufacturer specific field group B features:</p><div class="table-wrap"><table data-table-width="380" data-layout="default" data-local-id="93c84270-5297-4870-bb24-7e44b4bf714d" class="confluenceTable"><colgroup><col style="width: 84.0px;"/><col style="width: 296.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Bit(s)</strong></p></th><th class="confluenceTh"><p><strong>Field</strong></p></th></tr><tr><td class="confluenceTd"><p>15</p></td><td class="confluenceTd"><p>Reserved</p></td></tr><tr><td class="confluenceTd"><p>14</p></td><td class="confluenceTd"><p>Thread support</p></td></tr><tr><td class="confluenceTd"><p>13</p></td><td class="confluenceTd"><p>OTA reboot request</p></td></tr><tr><td class="confluenceTd"><p>12 – 0</p></td><td class="confluenceTd"><p>Reserved</p></td></tr></tbody></table></div><p>BLE_ota service and characteristics:</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="bf1c1e70-3f74-4eeb-a10e-e8c679d732c7" class="confluenceTable"><colgroup><col style="width: 160.0px;"/><col style="width: 119.0px;"/><col style="width: 83.0px;"/><col style="width: 103.0px;"/><col style="width: 295.0px;"/></colgroup><tbody><tr><td data-highlight-colour="#f4f5f7" colspan="5" class="confluenceTd"><p><strong>Service</strong></p></td></tr><tr><td class="confluenceTd"><p>OTA FW update</p></td><td class="confluenceTd"><p>UUID</p></td><td colspan="3" class="confluenceTd"><p>0000FE20-CC7A-482A-984A-7F2ED5B3E58F</p></td></tr><tr><td data-highlight-colour="#f4f5f7" colspan="5" class="confluenceTd"><p><strong>Characteristics</strong></p></td></tr><tr><td rowspan="6" class="confluenceTd"><p>Base address</p></td><td class="confluenceTd"><p>Function</p></td><td colspan="3" class="confluenceTd"><p>Address to store the file</p></td></tr><tr><td class="confluenceTd"><p>Size</p></td><td colspan="3" class="confluenceTd"><p>4</p></td></tr><tr><td class="confluenceTd"><p>Mode</p></td><td colspan="3" class="confluenceTd"><p>Write without response</p></td></tr><tr><td class="confluenceTd"><p>UUID</p></td><td colspan="3" class="confluenceTd"><p> 000FE22-8E22-4541-9D4C-21EDAE82ED19</p></td></tr><tr><td rowspan="2" class="confluenceTd"><p>Fields</p></td><td class="confluenceTd"><p>0</p></td><td class="confluenceTd"><p>Actions</p></td><td class="confluenceTd"><p>0x00: STOP all upload</p><p>0x01: START wireless file upload</p><p>0x02: START user application file upload</p><p>0x07: File upload finished</p><p>0x08: Cancel upload</p></td></tr><tr><td class="confluenceTd"><p>1</p></td><td class="confluenceTd"><p>Address</p></td><td class="confluenceTd"><p> 0x007000</p></td></tr><tr><td rowspan="5" class="confluenceTd"><p>File upload confirmation reboot</p></td><td class="confluenceTd"><p>Function</p></td><td colspan="3" class="confluenceTd"><p> Confirm the reboot of the application after file uploaded</p></td></tr><tr><td class="confluenceTd"><p>Size</p></td><td colspan="3" class="confluenceTd"><p>1</p></td></tr><tr><td class="confluenceTd"><p>Mode</p></td><td colspan="3" class="confluenceTd"><p>Indicate</p></td></tr><tr><td class="confluenceTd"><p>UUID</p></td><td colspan="3" class="confluenceTd"><p> 0000FE23-8E22-4541-9D4C-21EDAE82ED19</p></td></tr><tr><td class="confluenceTd"><p>Fields</p></td><td class="confluenceTd"><p>0</p></td><td class="confluenceTd"><p>0x01</p></td><td class="confluenceTd"><p>Reboot</p></td></tr><tr><td rowspan="5" class="confluenceTd"><p>OTA raw data</p></td><td class="confluenceTd"><p>Function</p></td><td colspan="3" class="confluenceTd"><p>Data to transfer file (split by 20 bytes)</p></td></tr><tr><td class="confluenceTd"><p>Size</p></td><td colspan="3" class="confluenceTd"><p>20</p></td></tr><tr><td class="confluenceTd"><p>Mode</p></td><td colspan="3" class="confluenceTd"><p>Write without response</p></td></tr><tr><td class="confluenceTd"><p>UUID</p></td><td colspan="3" class="confluenceTd"><p>0000FE24-8E22-4541-9D4C-21EDAE82ED19</p></td></tr><tr><td class="confluenceTd"><p>Fields</p></td><td class="confluenceTd"><p>0 – 19</p></td><td colspan="2" class="confluenceTd"><p>Raw data</p></td></tr></tbody></table></div><h6 id="OVC3.2.2.Firmware-OTAupdateprocess">OTA update process</h6><p>La siguiente figura muestra el flujo propuesto por STMicroelectronics y seguido por Onalabs. El flujo mostrado muestra un caso donde no se utiliza el SBSFU. Por ello, envía la dirección base y los sectores a borrar. En nuestro caso, el espacio para almacenar el archivo de actualización ya está fijado a la ranura 2, como se ha indicado anteriormente, por lo que no es necesario indicar una dirección base o sectores a borrar.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border image-center" alt="image-20240215-104444.png" width="1148" loading="lazy" src="attachments/22151169/364052616.png?width=1148" data-image-src="attachments/22151169/364052616.png" data-height="2047" data-width="4279" data-unresolved-comment-count="0" data-linked-resource-id="364052616" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240215-104444.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="ada5312b-ceb6-472f-8da9-9aa138f3c4f8" data-media-type="file"></span><h1 id="OVC3.2.2.Firmware-OTPmemorybank">OTP memory bank</h1><p>El banco de la memoria flash OTP (one-time-programable) es un espacio de la memoria flash del microcontrolador (0x1FFF7000 - 0x1FFF73FF) que, como su nombre indica, solo puede ser escrito una vez. El banco está organizado en 128 bloques de 64 bits. Cuando uno de los bits de esos bloques pasa de 1 a 0, la escritura del bloque queda totalmente bloqueada.</p><p>Este bloque se utiliza para almacenar datos invariables del dispositivo. Estos datos son:</p><ul><li><p>Pin de emparejamiento del Bluetooth LE (<code>uint32_t</code>)</p></li><li><p>Serial number (<code>char[13]</code>)</p></li><li><p>La versión del hardware/PCB (<code>char[4]</code>)</p></li><li><p>La MAC address (<code>uint8_t[6]</code>)</p></li><li><p>La clave IR (<code>uint8_t[16]</code>)</p></li><li><p>La clave ER (<code>uint8_t[16]</code>)</p></li></ul><p>Esos datos quedan mapeados en la memoria OTP del siguiente modo:</p><div class="table-wrap"><table data-table-width="456" data-layout="default" data-local-id="3b890726-4b3d-4e69-a156-a5787923bfb5" class="confluenceTable"><colgroup><col style="width: 215.0px;"/><col style="width: 241.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Address</strong></p></th><th class="confluenceTh"><p><strong>Content</strong></p></th></tr><tr><td class="confluenceTd"><p>0x1FFF7008 - 0x1FFF700B</p></td><td class="confluenceTd"><p>Bluetooth LE pairing pin</p></td></tr><tr><td class="confluenceTd"><p>0x1FFF700C - 0x1FFF7018</p></td><td class="confluenceTd"><p>Serial number</p></td></tr><tr><td class="confluenceTd"><p>0x1FFF7019 - 0x1FFF701C</p></td><td class="confluenceTd"><p>Hardware version</p></td></tr><tr><td class="confluenceTd"><p>0x1FFF701D - 0x1FFF7022</p></td><td class="confluenceTd"><p>MAC address</p></td></tr><tr><td class="confluenceTd"><p>0x1FFF7023 - 0x1FFF7032</p></td><td class="confluenceTd"><p>IR key</p></td></tr><tr><td class="confluenceTd"><p>0x1FFF7033 - 0x1FFF7042</p></td><td class="confluenceTd"><p>ER key</p></td></tr><tr><td class="confluenceTd"><p>0x1FFF7043 - 0x1FFF7047</p></td><td class="confluenceTd"><p>Filled with 0x00</p></td></tr></tbody></table></div><p>Con tal de optimizar el reducido espacio de la OTP, los datos se almacenan de manera no alineada. Por ello, su lectura debe de realizarse mediante la lectura byte a byte de la pertinente zona de memoria para su posterior reconstrucción. Los datos se almacenan en little endian.</p><p>Los datos no pueden ser almacenados justo al inicio de la memoria OTP puesto que STM32 almacena allí algunos datos como el ID del manufacturer registrado en el estándar de Bluetooth o el ID del dispositivo.</p><p>La OTP se programa durante la fase de producción mediante STM32CubeProgrammer.</p><h1 id="OVC3.2.2.Firmware-BLEcommunication">BLE communication</h1><p>La actualización de las características de las diferentes mediciones se realiza mediante Indications. De este modo, el cliente (aplicación móvil) debe de confirmar al servidor (Onavital) la recepción de la actualización de la característica. La recepción de la confirmación corresponde al evento <code>ACI_GATT_SERVER_CONFIRMATION_VSEVT_CODE</code>. Sin embargo, la no recepción corresponde a un evento de <em>timeout</em> llamado <code>ACI_GATT_PROC_TIMEOUT_EVENT</code> que tiene lugar pasados 30 segundos del envío de la actualización si no se ha recibido una confirmación por parte del cliente. En este evento, debe de finalizarse la conexión con el cliente si es que está establecida.</p><p>Sin embargo, esperar 30 segundo puede ser un tiempo excesivo en nuestra aplicación. Por ello, se implementa un <em>timeout</em> a parte de 2 segundos. Este timeout se inicia, seguidamente se envía la actualización de la característica. Debe de haber un timeout por característica y nunca permitir que se realice una nueva actualización de una característica si no se ha recibido previamente una confirmación de la actualización en curso. En el caso de haber un timeout, se deberá de terminar la conexión con el cliente mediante la función <code>ACI_GAP_TERMINATE</code>, tal y como recomienda el fabricante en su librería:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: c; gutter: false; theme: Confluence" data-theme="Confluence">/**
 * @brief ACI_GATT_PROC_TIMEOUT_EVENT
 * This event is generated by the client/server to the application on a GATT
 * timeout (30 seconds). This is a critical event that should not happen during
 * normal operating conditions. It is an indication of either a major
 * disruption in the communication link or a mistake in the application which
 * does not provide a reply to GATT procedures. After this event, the GATT
 * channel is closed and no more GATT communication can be performed. The
 * application is expected to issue an ACI_GAP_TERMINATE to disconnect from the
 * peer device. It is important to leave a 100 ms blank window before sending
 * the ACI_GAP_TERMINATE, since immediately after this event, system could save
 * important information in non-volatile memory.
 * 
 * @param Connection_Handle Specifies the ATT bearer for which the event
 *        applies.
 *        Values:
 *        - 0x0000 ... 0x0EFF: Unenhanced ATT bearer (the parameter is the
 *          connection handle)
 *        - 0xEA00 ... 0xEA3F: Enhanced ATT bearer (the LSB-byte of the
 *          parameter is the connection-oriented channel index)
 * @return None
 */
void aci_gatt_proc_timeout_event( uint16_t Connection_Handle );</pre>
</div></div><h1 id="OVC3.2.2.Firmware-Pushbutton">Push button</h1><p>The device has a button directly connected to the \MR pin of the BQ25150 component, which is responsible for charging the battery. The pin or button accepts 4 temporary configurations. That is, while the button is held down, the BQ25150 can be configured with up to 3 interrupts (t<sub>wake1</sub>, t<sub>wake2</sub>, th<sub>RESET_WARN</sub>) and a final configurable task (at th<sub>HW_RESET</sub>) during the time the button has been pressed.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border image-center" alt="image-20240301-111337.png" width="760" loading="lazy" src="attachments/22151169/364052622.png?width=760" data-image-src="attachments/22151169/364052622.png" data-height="772" data-width="1117" data-unresolved-comment-count="0" data-linked-resource-id="364052622" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240301-111337.png" data-base-url="https://onalabs.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="22151169" data-linked-resource-container-version="15" data-media-id="52c8ae8a-dbc2-4b6e-8c75-62de6b1b5390" data-media-type="file"></span><p>The desired use of the button for different instants depending on the time the button is held down is:</p><ul><li><p>After a time lapse of holding down the button (t<sub>wake1</sub>), the device deactivates the whitelist of BLE connections in order to allow the connection of a new central device (pairing mode).</p></li><li><p>If the button continues to be held down (until t<sub>wake2</sub>), the BLE connections whitelist is re-activated and the device enters ship mode.</p></li><li><p>If the button is kept pressed (until th<sub>HW_RESET</sub>) the device is reset.</p></li></ul><p>The user is notified by the LED indicator:</p><ul><li><p>When the device enters pairing mode, the LED flashes blue with a period of 250 ms.</p></li><li><p>When the device enters ship mode, the LED turns off.</p></li><li><p>When the device restarts, the LED lights red.</p></li></ul><p>Each interruption can be configured for different times. The configured times are as follows:</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="65252fa0-8ec6-44cb-96c1-2ca2a12d6230" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p><strong>Interrupt source</strong></p></th><th class="confluenceTh"><p><strong>Available values*</strong></p></th><th class="confluenceTh"><p><strong>Selected value</strong></p></th></tr><tr><td class="confluenceTd"><p>th<sub>wake1</sub></p></td><td class="confluenceTd"><p>125 ms<br/>500 ms</p></td><td class="confluenceTd"><p>125 ms</p></td></tr><tr><td class="confluenceTd"><p>th<sub>wake2</sub></p></td><td class="confluenceTd"><p>1 s<br/>2 s</p></td><td class="confluenceTd"><p>2 s</p></td></tr><tr><td class="confluenceTd"><p>th<sub>HW_RESET</sub></p></td><td class="confluenceTd"><p>4 s<br/>8 s<br/>10 s<br/>14 s</p></td><td class="confluenceTd"><p>4 s</p></td></tr><tr><td colspan="3" class="confluenceTd"><ul><li><p /></li></ul><p><sub>Time elapsed since the start of the button press.</sub></p></td></tr></tbody></table></div><h1 id="OVC3.2.2.Firmware-Batterymanagement">Battery management</h1><h2 id="OVC3.2.2.Firmware-Preventbatteryoverdischarge">Prevent battery overdischarge</h2><p>To prevent the device from losing the time set on the device once the battery runs out, and thus not forcing the user to connect to the mobile application to be able to take measurements again, the device must keep the VBAT pin of the microcontroller powered. This pin is responsible for powering the RTC. Initially, connecting the VDD pin to the BQ25150 battery charger was evaluated as an option because it was assumed that, when the battery voltage dropped below a preconfigured voltage level, the charger would continue to provide a regulated voltage of 1.8V. It has been verified that this is not the case and that no voltage is generated on that pin, since the charger does not cut the PMID power rail as indicated in the datasheet, but enters ship mode.</p><p>The alternative of connecting the VBAT pin of the microcontroller to the battery directly through a linear regulator was evaluated (necessary since the VBAT pin does not accept voltages as high as a fully charged battery can offer). The hardware manager commented on the difficulty of modifying the PCB design to incorporate this type of alternative. Therefore, a firmware solution was chosen.</p><p>The firmware solution consists of monitoring the battery voltage through the internal ADC of the BQ charger and setting an alarm at a predetermined voltage level for that ADC. Thus, when the battery voltage level drops below that threshold, the charger will notify the microcontroller about the event and the latter will go into minimum consumption mode until the power cable is reconnected.</p><ul class="decision-list"><li>Monitor the battery voltage via the battery charger's internal ADC and enter low power mode when the battery voltage drops below a certain predetermined threshold. The device should wake up once the power cable is reconnected.</li></ul><p>The battery charger remains in low power mode as long as the power cable is not connected (it automatically exits low power mode when there is a valid VIN voltage level). It is necessary to wake up the charger in order to perform a measurement with the ADC. The microcontroller wakes up the charger periodically every 10 minutes to perform an ADC conversion, check that there is no alarm and return the charger to low power mode.</p><h1 id="OVC3.2.2.Firmware-Developmentsetup">Development setup</h1><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Se hace referencia como firmware de desarrollo a aquel firmware que ha sido encriptado y firmado utilizando claves de desarrollo que no suponen un riesgo elevado que sean expuestas, y que tiene las medidas de seguridad deshabilitadas (como el RDP de nivel 2, el watchdog timer, entre otros).</p></div></div><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Se hace referencia a dispositivo de desarrollo como aquel dispositivo que tiene cargadas las claves de desarrollo. Estos dispositivos son dispositivos de uso exclusivamente interno en Onalabs.</p></div></div><h1 id="OVC3.2.2.Firmware-Flashingproductionfirmware">Flashing production firmware</h1><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Se hace referencia como firmware de producción a aquel firmware que ha sido encriptado y firmado utilizando claves de producción que no pueden ser expuestas. </p></div></div><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Se hace referencia a dispositivo de producción como aquel dispositivo que tiene cargadas las claves de producción y que ha sido sometido al procedimiento descrito en este apartado.</p></div></div><div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Seguir el procedimiento descrito para programar el firmware de producción en los dispositivos de producción es de vital importancia con tal de minimizar las probabilidades de que aparezca una vulnerabilidad en los dispositivos.</p></div></div><div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Una vez un dispositivo de producción ha sido sometido al procedimiento descrito en este apartado, no podrá volver a ser programado y el único modo de actualizar la aplicación de usuario será mediante una actualización OTA.</p></div></div><p /><p /><h2 id="OVC3.2.2.Firmware-AESkeyprovisioning">AES key provisioning</h2><h2 id="OVC3.2.2.Firmware-Optionbytesconfiguration">Option bytes configuration</h2><p /><h1 id="OVC3.2.2.Firmware-Externaldocuments">External documents</h1>

    
    

<div class="plugin_attachments_container">
    <div class="plugin_attachments_table_container">
        <fieldset class="hidden">
            <input type="hidden" class="plugin_attachments_macro_render_param" name="pageId" value="22151169">
            <input type="hidden" class="plugin_attachments_macro_render_param" name="totalPages" value="1">
            <input type="hidden" name="deleteConfirmMessage" value="Are you sure you want to send the attached file "{0}" to the trash? Only a space administrator can undo this action."/>
                                                 <input type="hidden" class="plugin_attachments_macro_render_param" name="patterns" value="*.pdf">
                                                                    <input type="hidden" name="outputType" value="html_export">
        </fieldset>
                






    


<table class="attachments aui"
    data-sort-by="date"
    data-sort-order=""
    data-tablesorter-headers='{"0": {"sorter": false}}'>
        <tr class="header-row">
        <th class="expand-column attachment-summary-toggle">&nbsp;</th>
        <th class="filename-column">
            File
        </th>
        <th class="modified-column">
            Modified
        </th>
    </tr>

        
    <tbody>
                    
                                
            <tr id="attachment-236388359"
                class="attachment-row"
                data-attachment-id="236388359">

                <td class="attachment-summary-toggle">
                    <span class="icon icon-section-closed" title="Show more info" role="button"
                          aria-expanded="false"></span>

                                        <div class="attachment-summary attachment-summary-236388359 hidden attachment-details-wrapper"
                         data-attachment-id="236388359"
                         data-attachment-filename="IOC configuration.pdf">

                                                    <div class="attachment-image-preview"></div>
                        
                                                <p class="attachment-labels">Labels</p>
                        
<div class="labels-section-content content-column" entityid="236388359" entitytype="attachment">
	<div class="labels-content">
		
    
    <ul class="label-list  has-pen" >
            <li class="no-labels-message">
            No labels
        </li>
                <li class="labels-edit-container">
            <a  aria-describedby="attach-236388359" href="#" class="show-labels-editor" title="Edit Labels" role="button">
                <span class="aui-icon aui-icon-small aui-iconfont-edit-small">Edit Labels</span>
            </a>
        </li>
        </ul>
    </div>
</div>
                                                    <div class="attachment-history-wrapper"></div>
                        
                                                    <div class="attachment-buttons">
                                                                        <a class="aui-button previewAttachmentLink"
                                           data-filename="IOC configuration.pdf"
                                           data-file-src="/wiki/download/attachments/22151169/IOC%20configuration.pdf?api=v2"
                                           data-linked-resource-default-alias="IOC configuration.pdf"
                                           data-mime-type="application/pdf"
                                           data-linked-resource-container-id="22151169"
                                           data-linked-resource-id="236388359"
                                           role="button">Preview</a>
                                
                                                                                                                                                                                                                            
                                    <a class="aui-button "
                                       href="$itemRenderedUrl"                          data-file-src="/download/attachments/22151169/IOC+configuration.pdf?version=1"
                                data-linked-resource-container-id="22151169"
                                data-linked-resource-default-alias="IOC+configuration.pdf"
                                data-linked-resource-id="236388359"
                                data-linked-resource-type="attachment"
                                role="button"
                         >$itemLabel</a>
                                                                                                                                                                                                                                                                
                                    <a class="aui-button editAttachmentLink"
                                       href="$itemRenderedUrl&amp;isFromPageView=true"                          role="button"
                         >$itemLabel</a>
                                                                                                                                                                                                                            
                                    <a class="aui-button removeAttachmentLink"
                                       href="$itemRenderedUrl&amp;isFromPageView=true"                          role="button"
                         >$itemLabel</a>
                                                            </div>
                                            </div>

                </td>

                <td class="filename-column">
                    <p>
                        

    


<span class="aui-icon content-type-attachment-pdf" title="PDF File" role="img">PDF File</span>                                                    <a class="filename" href="attachments/22151169/236388359.pdf" title="Download" data-filename="IOC configuration.pdf" data-type="application/pdf" data-linked-resource-container-id="22151169">
                                IOC configuration.pdf
                            </a>
                        
                                                                        
                                            </p>
                </td>

                <td class="attachment-created modified-column" data-sort-value="1708683444727">
                                        <span>Feb 23, 2024</span>
                    <span>by</span>
                                        <a href="/wiki/people/64060eb09ce2cd2c240f8264"
                                class="url fn confluence-userlink" data-account-id="64060eb09ce2cd2c240f8264"
                    >Albert Álvarez Carulla</a>
                            </td>
            </tr>
            
                                
            <tr id="attachment-364052586"
                class="attachment-row"
                data-attachment-id="364052586">

                <td class="attachment-summary-toggle">
                    <span class="icon icon-section-closed" title="Show more info" role="button"
                          aria-expanded="false"></span>

                                        <div class="attachment-summary attachment-summary-364052586 hidden attachment-details-wrapper"
                         data-attachment-id="364052586"
                         data-attachment-filename="DS-00480-GD25Q128E-Rev1.2.pdf">

                                                    <div class="attachment-image-preview"></div>
                        
                                                <p class="attachment-labels">Labels</p>
                        
<div class="labels-section-content content-column" entityid="364052586" entitytype="attachment">
	<div class="labels-content">
		
    
    <ul class="label-list  has-pen" >
            <li class="no-labels-message">
            No labels
        </li>
                <li class="labels-edit-container">
            <a  aria-describedby="attach-364052586" href="#" class="show-labels-editor" title="Edit Labels" role="button">
                <span class="aui-icon aui-icon-small aui-iconfont-edit-small">Edit Labels</span>
            </a>
        </li>
        </ul>
    </div>
</div>
                                                    <div class="attachment-history-wrapper"></div>
                        
                                                    <div class="attachment-buttons">
                                                                        <a class="aui-button previewAttachmentLink"
                                           data-filename="DS-00480-GD25Q128E-Rev1.2.pdf"
                                           data-file-src="/wiki/download/attachments/22151169/DS-00480-GD25Q128E-Rev1.2.pdf?api=v2"
                                           data-linked-resource-default-alias="DS-00480-GD25Q128E-Rev1.2.pdf"
                                           data-mime-type="application/pdf"
                                           data-linked-resource-container-id="22151169"
                                           data-linked-resource-id="364052586"
                                           role="button">Preview</a>
                                
                                                                                                                                                                                                                            
                                    <a class="aui-button "
                                       href="$itemRenderedUrl&amp;isFromPageView=true"                          data-file-src="/download/attachments/22151169/DS-00480-GD25Q128E-Rev1.2.pdf?version=1"
                                data-linked-resource-container-id="22151169"
                                data-linked-resource-default-alias="DS-00480-GD25Q128E-Rev1.2.pdf"
                                data-linked-resource-id="364052586"
                                data-linked-resource-type="attachment"
                                role="button"
                         >$itemLabel</a>
                                                                                                                                                                                                                                                                
                                    <a class="aui-button editAttachmentLink"
                                       href="$itemRenderedUrl&amp;isFromPageView=true&amp;isFromPageView=true"                          role="button"
                         >$itemLabel</a>
                                                                                                                                                                                                                            
                                    <a class="aui-button removeAttachmentLink"
                                       href="$itemRenderedUrl&amp;isFromPageView=true&amp;isFromPageView=true"                          role="button"
                         >$itemLabel</a>
                                                            </div>
                                            </div>

                </td>

                <td class="filename-column">
                    <p>
                        

    


<span class="aui-icon content-type-attachment-pdf" title="PDF File" role="img">PDF File</span>                                                    <a class="filename" href="attachments/22151169/364052586.pdf" title="Download" data-filename="DS-00480-GD25Q128E-Rev1.2.pdf" data-type="application/pdf" data-linked-resource-container-id="22151169">
                                DS-00480-GD25Q128E-Rev1.2.pdf
                            </a>
                        
                                                                        
                                            </p>
                </td>

                <td class="attachment-created modified-column" data-sort-value="1716373065876">
                                        <span>May 22, 2024</span>
                    <span>by</span>
                                        <a href="/wiki/people/604b6ce3ceccdd006a438a44"
                                class="url fn confluence-userlink" data-account-id="604b6ce3ceccdd006a438a44"
                    >Jaime Punter</a>
                            </td>
            </tr>
                        </tbody>
</table>


    </div>
    <div class="plugin_attachments_upload_container">
                                <div class="attachments-table-drop-zone">
                                <li class="drop-zone-text">
                    <div class="drop-zone-image"></div>
                    <span>Drag and drop to upload or <a class="aui-button aui-button-link browse-files">browse for files</a></span>
                    <img src="images/icons/wait.gif" class="plugin_attachments_dropzone_uploadwaiticon"/>
                </li>
                <form method="POST" class="plugin_attachments_uploadform aui hidden" action="/wiki/pages/plugins/attachments/doattachfile.action?pageId=22151169" enctype="multipart/form-data">
                    <input type="hidden" name="atl_token" value="${xsrfTokenGenerator.generateToken($request)}">
                    <div class="field-group">
                        <label>Upload file</label>
                        <input type="file" name="file_0" size="30">
                    </div>
                    <div class="field-group">
                        <label>File description</label>
                        <input type="text" class="blank-search text" name="comment_0" size="20" placeholder="Comment" >
                        <input type="hidden" name="labels" value="$macroParams.labels"/>
                    </div>
                    <div class="field-group">
                        <input type="submit" class="submit aui-button" name="confirm" value="Upload">
                    </div>
                    <iframe class="plugin_attachments_uploadiframe hidden" name="gZmC2oaM42msmBgY7VQT3hjhUZwAxg0tHgSjH5aSNwhxWryJ9m5VgsDOsEKKjeEK" src=""></iframe>
                </form>
            </div>
            </div>

    <div>
                    <a class="download-all-link" href="/wiki/download/all_attachments?pageId=22151169"
               title="Download all the latest versions of attachments on this content as single zip file.">Download All</a>
            </div>
</div>

<h3 id="OVC3.2.2.Firmware-DocumentDistribution">Document Distribution</h3><h1 id="OVC3.2.2.Firmware-Annex">Annex</h1><ul><li><p> <span class="confluence-embedded-file-wrapper"><a class="confluence-embedded-file" href="attachments/22151169/236388359.pdf" data-nice-type="PDF Document" data-file-src="/wiki/download/attachments/22151169/IOC%20configuration.pdf?version=1&amp;modificationDate=1708683444727&amp;cacheVersion=1&amp;api=v2" data-linked-resource-id="236388359" data-linked-resource-type="attachment" data-linked-resource-container-id="22151169" data-linked-resource-default-alias="IOC configuration.pdf" data-mime-type="application/pdf" data-has-thumbnail="true" data-linked-resource-version="1" data-media-id="3fa5ea5a-1106-49d7-8ff6-b755f2a1bcb2" data-media-type="file"><img src="attachments/thumbnails/22151169/236388359" height="250"/></a></span> </p></li></ul><h1 id="OVC3.2.2.Firmware-DocumentDistribution.1">Document Distribution</h1><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="d51499c6-f4f8-406e-8c0b-d1c031ce9c97" class="confluenceTable"><colgroup><col style="width: 380.0px;"/><col style="width: 380.0px;"/></colgroup><tbody><tr><td class="confluenceTd"><p> </p></td><td class="confluenceTd"><p>Action/ information</p></td></tr><tr><td class="confluenceTd"><p>This document is intended for an internal and (restricted) external audience.</p><p>The external audience may include the following organisations and regulators:</p><ul><li><p>Approved Bodies: conformity assessment bodies for the Medical Device Regulations.</p></li><li><p>Certification Body responsible for auditing and certifying the Quality Management System (QMS) to ISO 13485 </p></li><li><p>Third party contractors and suppliers involved in the manufacture</p></li></ul><p>All external distribution of this document must be approved prior to circulation.</p></td><td class="confluenceTd"><p>Information</p><p> </p></td></tr></tbody></table></div><p> </p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/22151182.png">image-20210726-105018.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/225050671.docx">[OVFYS00001] ONAVITAL firmware requeriments and specifications.docx</a> (application/vnd.openxmlformats-officedocument.wordprocessingml.document)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/84410369.docx">[OVFYS00001] ONAVITAL firmware requeriments and specifications.docx</a> (application/vnd.openxmlformats-officedocument.wordprocessingml.document)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/235733007.png">image-20240223-095854.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/235831300.png">image-20240223-095950.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/234913836.png">image-20240223-100040.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/236388353.png">image-20240223-100053.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/235995141.png">image-20240223-100110.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/236126214.png">image-20240223-100123.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/236158980.png">image-20240223-100139.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/236322818.png">image-20240223-100155.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/235929609.png">image-20240223-100209.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/236388359.pdf">IOC configuration.pdf</a> (application/pdf)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/235831310.svg">Imagen 1.svg</a> (image/svg+xml)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/235831335.png">Imagen 1.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/236191751.png">image-20240223-115647.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/235929625.png">image-20240223-115809.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/236159024.png">image-20240223-115812.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/236060696.png">image-20240223-115836.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/235798539.png">image-20240223-115858.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/235733022.png">image-20240223-115930.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/235831329.png">image-20240223-120001.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/235700243.png">image-20240223-120030.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/236027910.png">image-20240223-120057.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/236290061.png">Imagen 1.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052550.svg">green_raw_channel_external_supply.svg</a> (image/svg+xml)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052556.svg">green_raw_channel_battery.svg</a> (image/svg+xml)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052562.svg">red_raw_channel.svg</a> (image/svg+xml)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052568.svg">infrared_raw_channel.svg</a> (image/svg+xml)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052574.xlsx">PPG validation on finger.xlsx</a> (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052580.svg">Non-Volatile FIFO Initialization (1).svg</a> (image/svg+xml)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052586.pdf">DS-00480-GD25Q128E-Rev1.2.pdf</a> (application/pdf)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052592.svg">Proposal 1 Analysis.svg</a> (image/svg+xml)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052598.svg">Data Structure for Propsal 1.svg</a> (image/svg+xml)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052604.svg">Proposal 2.svg</a> (image/svg+xml)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052610.png">image-20240214-172017.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052616.png">image-20240215-104444.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22151169/364052622.png">image-20240301-111337.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Jun 30, 2025 15:49</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
